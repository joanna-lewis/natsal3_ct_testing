), 'ci'
))
}
for(i in sort(unique(npart_f))){
print(i)
print(table(n2$c_result[(n2$rsex == 'female') &
(n2$het == 'het. sex. intercourse aged 13+') &
(n2$het1yr %in% 1:901) &
(n2$hetnonew == i)]))
print(100*svyciprop(~(c_result == 1),
design = subset(n2design,
(n2$rsex == 'female') &
(n2$het == 'het. sex. intercourse aged 13+') &
(n2$het1yr %in% 1:901) &
(n2$hetnonew == i) &
(n2$c_result %in% c(0,1))
),
method = "beta"
)
)
print(100*attr(svyciprop(~(c_result == 1),
design = subset(n2design,
(n2$rsex == 'female') &
(n2$het == 'het. sex. intercourse aged 13+') &
(n2$het1yr %in% 1:901) &
(n2$hetnonew == i) &
(n2$c_result %in% c(0,1))
),
method = "beta"
), 'ci'
))
}
for(i in sort(unique(npart_f))){
print(i)
print(table(n2$c_result[(n2$rsex == 'female') &
(n2$het == 'het. sex. intercourse aged 13+') &
(n2$het1yr %in% 1:901) &
(n2$hetnonew == i)]))
print(100*svyciprop(~(c_result == 1),
design = subset(n2design,
(n2$rsex == 'female') &
(n2$het == 'het. sex. intercourse aged 13+') &
(n2$het1yr %in% 1:901) &
(n2$hetnonew == i) &
(n2$c_result %in% c(0,1))
),
method = "likelihood"
)
)
print(100*attr(svyciprop(~(c_result == 1),
design = subset(n2design,
(n2$rsex == 'female') &
(n2$het == 'het. sex. intercourse aged 13+') &
(n2$het1yr %in% 1:901) &
(n2$hetnonew == i) &
(n2$c_result %in% c(0,1))
),
method = "likelihood"
), 'ci'
))
}
for(i in sort(unique(npart_f))){
print(i)
print(table(n2$c_result[(n2$rsex == 'female') &
(n2$het == 'het. sex. intercourse aged 13+') &
(n2$het1yr %in% 1:901) &
(n2$hetnonew == i)]))
try(print(100*svyciprop(~(c_result == 1),
design = subset(n2design,
(n2$rsex == 'female') &
(n2$het == 'het. sex. intercourse aged 13+') &
(n2$het1yr %in% 1:901) &
(n2$hetnonew == i) &
(n2$c_result %in% c(0,1))
),
method = "likelihood"
)
))
try(print(100*attr(svyciprop(~(c_result == 1),
design = subset(n2design,
(n2$rsex == 'female') &
(n2$het == 'het. sex. intercourse aged 13+') &
(n2$het1yr %in% 1:901) &
(n2$hetnonew == i) &
(n2$c_result %in% c(0,1))
),
method = "likelihood"
), 'ci'
)))
}
for(i in sort(unique(npart_f))){
print(i)
print(table(n2$c_result[(n2$rsex == 'female') &
(n2$het == 'het. sex. intercourse aged 13+') &
(n2$het1yr %in% 1:901) &
(n2$hetnonew == i)]))
print(100*svyciprop(~(c_result == 1),
design = subset(n2design,
(n2$rsex == 'female') &
(n2$het == 'het. sex. intercourse aged 13+') &
(n2$het1yr %in% 1:901) &
(n2$hetnonew == i) &
(n2$c_result %in% c(0,1))
),
method = "beta"
)
)
print(100*attr(svyciprop(~(c_result == 1),
design = subset(n2design,
(n2$rsex == 'female') &
(n2$het == 'het. sex. intercourse aged 13+') &
(n2$het1yr %in% 1:901) &
(n2$hetnonew == i) &
(n2$c_result %in% c(0,1))
),
method = "beta"
), 'ci'
))
}
rm(list=ls())
# setwd('/Users/Joanna/OneDrive - Imperial College London/backup/papers/transmission_probs/ct_transmission_prob')
library(foreign)
library(rstan)
library(survey)
library(deSolve)
library(boot)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
alldata <- NULL # set up data frame
# NHANES 09-10 data
nhanes_09_10_dem <- read.xport('/Users/Joanna/OneDrive - Imperial College London/backup/data/NHANES/data/2009-2010/DEMO_F.XPT')
nhanes_09_10_ctgc <- read.xport('/Users/Joanna/OneDrive - Imperial College London/backup/data/NHANES/data/2009-2010/CHLMDA_F.XPT')
nhanes_09_10_beh <- read.xport('/Users/Joanna/OneDrive - Imperial College London/backup/data/NHANES/data/2009-2010/SXQ_F.XPT')
nhanes_09_10 <- merge(nhanes_09_10_dem, nhanes_09_10_ctgc, all=TRUE)
nhanes_09_10 <- merge(nhanes_09_10, nhanes_09_10_beh, all=TRUE)
data_09_10 <- data.frame(
survey = "2009-2010",
id = nhanes_09_10$SEQN,
sex = nhanes_09_10$RIAGENDR,
partners = ifelse(nhanes_09_10$RIAGENDR == 1, nhanes_09_10$SXQ827, nhanes_09_10$SXQ727),
shift_partners = ifelse(nhanes_09_10$RIAGENDR == 1, nhanes_09_10$SXQ827, nhanes_09_10$SXQ727),
ct = nhanes_09_10$URXUCL,
weight = nhanes_09_10$WTMEC2YR
)
data_09_10$shift_partners[which(nhanes_09_10$SXQ648 == 2)] <- 0 # if state no new partners
# >= 1 new partner, and one partner total => one new partner
data_09_10$shift_partners[which((nhanes_09_10$RIAGENDR == 1) & (nhanes_09_10$SXQ648 == 1) & (nhanes_09_10$SXQ827 == 1))] <- 1
data_09_10$shift_partners[which((nhanes_09_10$RIAGENDR == 2) & (nhanes_09_10$SXQ648 == 1) & (nhanes_09_10$SXQ727 == 1))] <- 1
# >= 1 new partner, and >1 partner total => assume new partners = partners-1
data_09_10$shift_partners[which((nhanes_09_10$RIAGENDR == 1) & (nhanes_09_10$SXQ648 == 1) & (nhanes_09_10$SXQ827 > 1))] <-
nhanes_09_10$SXQ827[which((nhanes_09_10$RIAGENDR == 1) & (nhanes_09_10$SXQ648 == 1) & (nhanes_09_10$SXQ827 > 1))] - 1
data_09_10$shift_partners[which((nhanes_09_10$RIAGENDR == 2) & (nhanes_09_10$SXQ648 == 1) & (nhanes_09_10$SXQ727 > 1))] <-
nhanes_09_10$SXQ727[which((nhanes_09_10$RIAGENDR == 2) & (nhanes_09_10$SXQ648 == 1) & (nhanes_09_10$SXQ727 > 1))] - 1
data_09_10 <- data_09_10[which(complete.cases(data_09_10)),]
data_09_10 <- data_09_10[data_09_10$partners %in% (1:999),]
data_09_10$weight <- nrow(data_09_10) * data_09_10$weight / sum(data_09_10$weight)
alldata <- rbind(alldata, data_09_10)
# NHANES 11-12 data
nhanes_11_12_dem <- read.xport('/Users/Joanna/OneDrive - Imperial College London/backup/data/NHANES/data/2011-2012/DEMO_G.XPT')
nhanes_11_12_ctgc <- read.xport('/Users/Joanna/OneDrive - Imperial College London/backup/data/NHANES/data/2011-2012/CHLMDA_G.XPT')
nhanes_11_12_beh <- read.xport('/Users/Joanna/OneDrive - Imperial College London/backup/data/NHANES/data/2011-2012/SXQ_G.XPT')
nhanes_11_12 <- merge(nhanes_11_12_dem, nhanes_11_12_ctgc, all=TRUE)
nhanes_11_12 <- merge(nhanes_11_12, nhanes_11_12_beh, all=TRUE)
data_11_12 <- data.frame(
survey = "2011-2012",
id = nhanes_11_12$SEQN,
sex = nhanes_11_12$RIAGENDR,
partners = ifelse(nhanes_11_12$RIAGENDR == 1, nhanes_11_12$SXQ827, nhanes_11_12$SXQ727),
shift_partners = NA, # ifelse(nhanes_11_12$RIAGENDR == 1, nhanes_11_12$SXQ827 - 1, nhanes_11_12$SXQ727 - 1),
ct = nhanes_11_12$URXUCL,
weight = nhanes_11_12$WTMEC2YR
)
data_11_12$shift_partners[which(nhanes_11_12$SXQ648 == 2)] <- 0 # if state no new partners
# >= 1 new partner, and one partner total => one new partner
data_11_12$shift_partners[which((nhanes_11_12$RIAGENDR == 1) & (nhanes_11_12$SXQ648 == 1) & (nhanes_11_12$SXQ827 == 1))] <- 1
data_11_12$shift_partners[which((nhanes_11_12$RIAGENDR == 2) & (nhanes_11_12$SXQ648 == 1) & (nhanes_11_12$SXQ727 == 1))] <- 1
# >= 1 new partner, and >1 partner total => assume new partners = partners-1
data_11_12$shift_partners[which((nhanes_11_12$RIAGENDR == 1) & (nhanes_11_12$SXQ648 == 1) & (nhanes_11_12$SXQ827 > 1))] <-
nhanes_11_12$SXQ827[which((nhanes_11_12$RIAGENDR == 1) & (nhanes_11_12$SXQ648 == 1) & (nhanes_11_12$SXQ827 > 1))] - 1
data_11_12$shift_partners[which((nhanes_11_12$RIAGENDR == 2) & (nhanes_11_12$SXQ648 == 1) & (nhanes_11_12$SXQ727 > 1))] <-
nhanes_11_12$SXQ727[which((nhanes_11_12$RIAGENDR == 2) & (nhanes_11_12$SXQ648 == 1) & (nhanes_11_12$SXQ727 > 1))] - 1
data_11_12 <- data_11_12[which(complete.cases(data_11_12)),]
data_11_12 <- data_11_12[data_11_12$partners %in% (1:999),]
data_11_12$weight <- nrow(data_11_12) * data_11_12$weight / sum(data_11_12$weight)
alldata <- rbind(alldata, data_11_12)
# NHANES 13-14 data
nhanes_13_14_dem <- read.xport('/Users/Joanna/OneDrive - Imperial College London/backup/data/NHANES/data/2013-2014/DEMO_H.XPT')
nhanes_13_14_ctgc <- read.xport('/Users/Joanna/OneDrive - Imperial College London/backup/data/NHANES/data/2013-2014/CHLMDA_H.XPT')
nhanes_13_14_beh <- read.xport('/Users/Joanna/OneDrive - Imperial College London/backup/data/NHANES/data/2013-2014/SXQ_H.XPT')
nhanes_13_14 <- merge(nhanes_13_14_dem, nhanes_13_14_ctgc, all=TRUE)
nhanes_13_14 <- merge(nhanes_13_14, nhanes_13_14_beh, all=TRUE)
data_13_14 <- data.frame(
survey = "2013-2014",
id = nhanes_13_14$SEQN,
sex = nhanes_13_14$RIAGENDR,
partners = ifelse(nhanes_13_14$RIAGENDR == 1, nhanes_13_14$SXQ827, nhanes_13_14$SXQ727),
shift_partners = NA, #ifelse(nhanes_13_14$RIAGENDR == 1, nhanes_13_14$SXQ827 - 1, nhanes_13_14$SXQ727 - 1),
ct = nhanes_13_14$URXUCL,
weight = nhanes_13_14$WTMEC2YR
)
data_13_14$shift_partners[which(nhanes_13_14$SXQ648 == 2)] <- 0 # if state no new partners
# >= 1 new partner, and one partner total => one new partner
data_13_14$shift_partners[which((nhanes_13_14$RIAGENDR == 1) & (nhanes_13_14$SXQ648 == 1) & (nhanes_13_14$SXQ827 == 1))] <- 1
data_13_14$shift_partners[which((nhanes_13_14$RIAGENDR == 2) & (nhanes_13_14$SXQ648 == 1) & (nhanes_13_14$SXQ727 == 1))] <- 1
# >= 1 new partner, and >1 partner total => assume new partners = partners-1
data_13_14$shift_partners[which((nhanes_13_14$RIAGENDR == 1) & (nhanes_13_14$SXQ648 == 1) & (nhanes_13_14$SXQ827 > 1))] <-
nhanes_13_14$SXQ827[which((nhanes_13_14$RIAGENDR == 1) & (nhanes_13_14$SXQ648 == 1) & (nhanes_13_14$SXQ827 > 1))] - 1
data_13_14$shift_partners[which((nhanes_13_14$RIAGENDR == 2) & (nhanes_13_14$SXQ648 == 1) & (nhanes_13_14$SXQ727 > 1))] <-
nhanes_13_14$SXQ727[which((nhanes_13_14$RIAGENDR == 2) & (nhanes_13_14$SXQ648 == 1) & (nhanes_13_14$SXQ727 > 1))] - 1
data_13_14 <- data_13_14[which(complete.cases(data_13_14)),]
data_13_14 <- data_13_14[data_13_14$partners %in% (1:999),]
data_13_14$weight <- nrow(data_13_14) * data_13_14$weight / sum(data_13_14$weight)
alldata <- rbind(alldata, data_13_14)
####################################
# number of new partners in the last year
####################################
######
# men
######
npart_m <- alldata$shift_partners[(alldata$sex == 1)]
ntab_m <- table(npart_m)
ntab_m <- data.frame(ntab_m)
names(ntab_m) <- c('n', 'freq')
ntab_m$prop <- ntab_m$freq/sum(ntab_m$freq)
ntab_m$low.95 <- ntab_m$high.95 <- ntab_m$prop_wt <- NA
sub <- subset(alldata, alldata$sex == 1)
for(i in 1:(nrow(ntab_m))){
ntab_m$low.95[i] <- binom.test(ntab_m$freq[i], sum(ntab_m$freq))$conf.int[[1]]
ntab_m$high.95[i] <- binom.test(ntab_m$freq[i], sum(ntab_m$freq))$conf.int[[2]]
ntab_m$prop_wt[i] <- sum(sub$weight[sub$shift_partners == as.numeric(as.character(ntab_m$n[i]))]) / sum(sub$weight)
}
######
# women
######
npart_f <- alldata$shift_partners[(alldata$sex == 2)]
ntab_f <- table(npart_f)
ntab_f <- data.frame(ntab_f)
names(ntab_f) <- c('n', 'freq')
ntab_f$prop <- ntab_f$freq/sum(ntab_f$freq)
ntab_f$low.95 <- ntab_f$high.95 <- ntab_f$prop_wt <- NA
sub <- subset(alldata, alldata$sex == 2)
for(i in 1:(nrow(ntab_f))){
ntab_f$low.95[i] <- binom.test(ntab_f$freq[i], sum(ntab_f$freq))$conf.int[[1]]
ntab_f$high.95[i] <- binom.test(ntab_f$freq[i], sum(ntab_f$freq))$conf.int[[2]]
ntab_f$prop_wt[i] <- sum(sub$weight[sub$shift_partners == as.numeric(as.character(ntab_f$n[i]))]) / sum(sub$weight)
}
rm(list=ls())
# setwd('/Users/Joanna/OneDrive - Imperial College London/backup/papers/transmission_probs/ct_transmission_prob')
library(foreign)
library(rstan)
library(survey)
library(deSolve)
library(boot)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())
alldata <- NULL # set up data frame
# NHANES 09-10 data
nhanes_09_10_dem <- read.xport('/Users/Joanna/OneDrive - Imperial College London/backup/data/NHANES/data/2009-2010/DEMO_F.XPT')
nhanes_09_10_ctgc <- read.xport('/Users/Joanna/OneDrive - Imperial College London/backup/data/NHANES/data/2009-2010/CHLMDA_F.XPT')
nhanes_09_10_beh <- read.xport('/Users/Joanna/OneDrive - Imperial College London/backup/data/NHANES/data/2009-2010/SXQ_F.XPT')
nhanes_09_10 <- merge(nhanes_09_10_dem, nhanes_09_10_ctgc, all=TRUE)
nhanes_09_10 <- merge(nhanes_09_10, nhanes_09_10_beh, all=TRUE)
data_09_10 <- data.frame(
survey = "2009-2010",
id = nhanes_09_10$SEQN,
sex = nhanes_09_10$RIAGENDR,
partners = ifelse(nhanes_09_10$RIAGENDR == 1, nhanes_09_10$SXQ827, nhanes_09_10$SXQ727),
shift_partners = ifelse(nhanes_09_10$RIAGENDR == 1, nhanes_09_10$SXQ827, nhanes_09_10$SXQ727),
ct = nhanes_09_10$URXUCL,
weight = nhanes_09_10$WTMEC2YR,
psu = nhanes_09_10$SDMVPSU,
str = nhanes_09_10$SDMVSTRA
)
data_09_10$shift_partners[which(nhanes_09_10$SXQ648 == 2)] <- 0 # if state no new partners
# >= 1 new partner, and one partner total => one new partner
data_09_10$shift_partners[which((nhanes_09_10$RIAGENDR == 1) & (nhanes_09_10$SXQ648 == 1) & (nhanes_09_10$SXQ827 == 1))] <- 1
data_09_10$shift_partners[which((nhanes_09_10$RIAGENDR == 2) & (nhanes_09_10$SXQ648 == 1) & (nhanes_09_10$SXQ727 == 1))] <- 1
# >= 1 new partner, and >1 partner total => assume new partners = partners-1
data_09_10$shift_partners[which((nhanes_09_10$RIAGENDR == 1) & (nhanes_09_10$SXQ648 == 1) & (nhanes_09_10$SXQ827 > 1))] <-
nhanes_09_10$SXQ827[which((nhanes_09_10$RIAGENDR == 1) & (nhanes_09_10$SXQ648 == 1) & (nhanes_09_10$SXQ827 > 1))] - 1
data_09_10$shift_partners[which((nhanes_09_10$RIAGENDR == 2) & (nhanes_09_10$SXQ648 == 1) & (nhanes_09_10$SXQ727 > 1))] <-
nhanes_09_10$SXQ727[which((nhanes_09_10$RIAGENDR == 2) & (nhanes_09_10$SXQ648 == 1) & (nhanes_09_10$SXQ727 > 1))] - 1
data_09_10 <- data_09_10[which(complete.cases(data_09_10)),]
data_09_10 <- data_09_10[data_09_10$partners %in% (1:999),]
data_09_10$weight <- nrow(data_09_10) * data_09_10$weight / sum(data_09_10$weight)
alldata <- rbind(alldata, data_09_10)
# NHANES 11-12 data
nhanes_11_12_dem <- read.xport('/Users/Joanna/OneDrive - Imperial College London/backup/data/NHANES/data/2011-2012/DEMO_G.XPT')
nhanes_11_12_ctgc <- read.xport('/Users/Joanna/OneDrive - Imperial College London/backup/data/NHANES/data/2011-2012/CHLMDA_G.XPT')
nhanes_11_12_beh <- read.xport('/Users/Joanna/OneDrive - Imperial College London/backup/data/NHANES/data/2011-2012/SXQ_G.XPT')
nhanes_11_12 <- merge(nhanes_11_12_dem, nhanes_11_12_ctgc, all=TRUE)
nhanes_11_12 <- merge(nhanes_11_12, nhanes_11_12_beh, all=TRUE)
data_11_12 <- data.frame(
survey = "2011-2012",
id = nhanes_11_12$SEQN,
sex = nhanes_11_12$RIAGENDR,
partners = ifelse(nhanes_11_12$RIAGENDR == 1, nhanes_11_12$SXQ827, nhanes_11_12$SXQ727),
shift_partners = NA, # ifelse(nhanes_11_12$RIAGENDR == 1, nhanes_11_12$SXQ827 - 1, nhanes_11_12$SXQ727 - 1),
ct = nhanes_11_12$URXUCL,
weight = nhanes_11_12$WTMEC2YR,
psu = nhanes_11_12$SDMVPSU,
str = nhanes_11_12$SDMVSTRA
)
data_11_12$shift_partners[which(nhanes_11_12$SXQ648 == 2)] <- 0 # if state no new partners
# >= 1 new partner, and one partner total => one new partner
data_11_12$shift_partners[which((nhanes_11_12$RIAGENDR == 1) & (nhanes_11_12$SXQ648 == 1) & (nhanes_11_12$SXQ827 == 1))] <- 1
data_11_12$shift_partners[which((nhanes_11_12$RIAGENDR == 2) & (nhanes_11_12$SXQ648 == 1) & (nhanes_11_12$SXQ727 == 1))] <- 1
# >= 1 new partner, and >1 partner total => assume new partners = partners-1
data_11_12$shift_partners[which((nhanes_11_12$RIAGENDR == 1) & (nhanes_11_12$SXQ648 == 1) & (nhanes_11_12$SXQ827 > 1))] <-
nhanes_11_12$SXQ827[which((nhanes_11_12$RIAGENDR == 1) & (nhanes_11_12$SXQ648 == 1) & (nhanes_11_12$SXQ827 > 1))] - 1
data_11_12$shift_partners[which((nhanes_11_12$RIAGENDR == 2) & (nhanes_11_12$SXQ648 == 1) & (nhanes_11_12$SXQ727 > 1))] <-
nhanes_11_12$SXQ727[which((nhanes_11_12$RIAGENDR == 2) & (nhanes_11_12$SXQ648 == 1) & (nhanes_11_12$SXQ727 > 1))] - 1
data_11_12 <- data_11_12[which(complete.cases(data_11_12)),]
data_11_12 <- data_11_12[data_11_12$partners %in% (1:999),]
data_11_12$weight <- nrow(data_11_12) * data_11_12$weight / sum(data_11_12$weight)
alldata <- rbind(alldata, data_11_12)
# NHANES 13-14 data
nhanes_13_14_dem <- read.xport('/Users/Joanna/OneDrive - Imperial College London/backup/data/NHANES/data/2013-2014/DEMO_H.XPT')
nhanes_13_14_ctgc <- read.xport('/Users/Joanna/OneDrive - Imperial College London/backup/data/NHANES/data/2013-2014/CHLMDA_H.XPT')
nhanes_13_14_beh <- read.xport('/Users/Joanna/OneDrive - Imperial College London/backup/data/NHANES/data/2013-2014/SXQ_H.XPT')
nhanes_13_14 <- merge(nhanes_13_14_dem, nhanes_13_14_ctgc, all=TRUE)
nhanes_13_14 <- merge(nhanes_13_14, nhanes_13_14_beh, all=TRUE)
data_13_14 <- data.frame(
survey = "2013-2014",
id = nhanes_13_14$SEQN,
sex = nhanes_13_14$RIAGENDR,
partners = ifelse(nhanes_13_14$RIAGENDR == 1, nhanes_13_14$SXQ827, nhanes_13_14$SXQ727),
shift_partners = NA, #ifelse(nhanes_13_14$RIAGENDR == 1, nhanes_13_14$SXQ827 - 1, nhanes_13_14$SXQ727 - 1),
ct = nhanes_13_14$URXUCL,
weight = nhanes_13_14$WTMEC2YR,
psu = nhanes_13_14$SDMVPSU,
str = nhanes_13_14$SDMVSTRA
)
data_13_14$shift_partners[which(nhanes_13_14$SXQ648 == 2)] <- 0 # if state no new partners
# >= 1 new partner, and one partner total => one new partner
data_13_14$shift_partners[which((nhanes_13_14$RIAGENDR == 1) & (nhanes_13_14$SXQ648 == 1) & (nhanes_13_14$SXQ827 == 1))] <- 1
data_13_14$shift_partners[which((nhanes_13_14$RIAGENDR == 2) & (nhanes_13_14$SXQ648 == 1) & (nhanes_13_14$SXQ727 == 1))] <- 1
# >= 1 new partner, and >1 partner total => assume new partners = partners-1
data_13_14$shift_partners[which((nhanes_13_14$RIAGENDR == 1) & (nhanes_13_14$SXQ648 == 1) & (nhanes_13_14$SXQ827 > 1))] <-
nhanes_13_14$SXQ827[which((nhanes_13_14$RIAGENDR == 1) & (nhanes_13_14$SXQ648 == 1) & (nhanes_13_14$SXQ827 > 1))] - 1
data_13_14$shift_partners[which((nhanes_13_14$RIAGENDR == 2) & (nhanes_13_14$SXQ648 == 1) & (nhanes_13_14$SXQ727 > 1))] <-
nhanes_13_14$SXQ727[which((nhanes_13_14$RIAGENDR == 2) & (nhanes_13_14$SXQ648 == 1) & (nhanes_13_14$SXQ727 > 1))] - 1
data_13_14 <- data_13_14[which(complete.cases(data_13_14)),]
data_13_14 <- data_13_14[data_13_14$partners %in% (1:999),]
data_13_14$weight <- nrow(data_13_14) * data_13_14$weight / sum(data_13_14$weight)
alldata <- rbind(alldata, data_13_14)
####################################
# number of new partners in the last year
####################################
######
# men
######
npart_m <- alldata$shift_partners[(alldata$sex == 1)]
ntab_m <- table(npart_m)
ntab_m <- data.frame(ntab_m)
names(ntab_m) <- c('n', 'freq')
ntab_m$prop <- ntab_m$freq/sum(ntab_m$freq)
ntab_m$low.95 <- ntab_m$high.95 <- ntab_m$prop_wt <- NA
sub <- subset(alldata, alldata$sex == 1)
for(i in 1:(nrow(ntab_m))){
ntab_m$low.95[i] <- binom.test(ntab_m$freq[i], sum(ntab_m$freq))$conf.int[[1]]
ntab_m$high.95[i] <- binom.test(ntab_m$freq[i], sum(ntab_m$freq))$conf.int[[2]]
ntab_m$prop_wt[i] <- sum(sub$weight[sub$shift_partners == as.numeric(as.character(ntab_m$n[i]))]) / sum(sub$weight)
}
######
# women
######
npart_f <- alldata$shift_partners[(alldata$sex == 2)]
ntab_f <- table(npart_f)
ntab_f <- data.frame(ntab_f)
names(ntab_f) <- c('n', 'freq')
ntab_f$prop <- ntab_f$freq/sum(ntab_f$freq)
ntab_f$low.95 <- ntab_f$high.95 <- ntab_f$prop_wt <- NA
sub <- subset(alldata, alldata$sex == 2)
for(i in 1:(nrow(ntab_f))){
ntab_f$low.95[i] <- binom.test(ntab_f$freq[i], sum(ntab_f$freq))$conf.int[[1]]
ntab_f$high.95[i] <- binom.test(ntab_f$freq[i], sum(ntab_f$freq))$conf.int[[2]]
ntab_f$prop_wt[i] <- sum(sub$weight[sub$shift_partners == as.numeric(as.character(ntab_f$n[i]))]) / sum(sub$weight)
}
nhanesdesign <- svydesign(
ids = ~ psu,
weights = ~ weight,
strata = ~ str,
data = alldata
)
nhanesdesign <- svydesign(
ids = ~ psu,
weights = ~ weight,
strata = ~ str,
data = alldata,
)
nhanesdesign <- svydesign(
ids = ~ psu,
weights = ~ weight,
strata = ~ str,
data = alldata,
nest=TRUE
)
names(nhanes)
names(alldata)
table(alldata$sex)
table(alldata$ct)
i <- 0
print(i)
print(table(alldata$ct[(alldata$rsex == 1) &
(alldata$shift_partners == i)]))
table(alldata$ct[(alldata$rsex == 1) &
+                          (alldata$shift_partners == i)])
table(alldata$ct)
table(alldata$ct, alldata$sex)
print(table(alldata$ct[(alldata$sex == 1) &
(alldata$shift_partners == i)]))
print(100*svyciprop(~(ct == 1),
design = subset(nhanesdesign,
(alldata$sex == 1) &
(alldata$shift_partners == i) &
(alldata$ct %in% c(1,2))
),
method = "beta"
)
print(100*svyciprop(~(ct == 1),
design = subset(nhanesdesign,
(alldata$sex == 1) &
(alldata$shift_partners == i) &
(alldata$ct %in% c(1,2))
),
method = "beta"
)
)
svyciprop(~(ct == 1),
design = subset(nhanesdesign,
(alldata$sex == 1) &
(alldata$shift_partners == i) &
(alldata$ct %in% c(1,2))
),
method = "beta"
)
print(100*svyciprop(~(ct == 1),
design = subset(nhanesdesign,
(alldata$sex == 1) &
(alldata$shift_partners == i) &
(alldata$ct %in% c(1,2))
),
method = "beta"
)
)
print(100*attr(svyciprop(~(ct == 1),
design = subset(nhanesdesign,
(alldata$rsex == 1) &
(alldata$shift_partners == i) &
(alldata$ct %in% c(1,2))
),
method = "beta"
), 'ci'
))
print(100*attr(svyciprop(~(ct == 1),
design = subset(nhanesdesign,
(alldata$sex == 1) &
(alldata$shift_partners == i) &
(alldata$ct %in% c(1,2))
),
method = "beta"
), 'ci'
))
####################################
# tabulate partner numbers and infection status
####################################
for(i in sort(unique(npart_m))){
print(i)
print(table(alldata$ct[(alldata$sex == 1) &
(alldata$shift_partners == i)]))
print(100*svyciprop(~(ct == 1),
design = subset(nhanesdesign,
(alldata$sex == 1) &
(alldata$shift_partners == i) &
(alldata$ct %in% c(1,2))
),
method = "beta"
))
print(100*attr(svyciprop(~(ct == 1),
design = subset(nhanesdesign,
(alldata$sex == 1) &
(alldata$shift_partners == i) &
(alldata$ct %in% c(1,2))
),
method = "beta"
), 'ci'
))
}
for(i in sort(unique(npart_f))){
print(i)
print(table(alldata$ct[(alldata$sex == 2) &
(alldata$shift_partners == i)]))
print(100*svyciprop(~(ct == 1),
design = subset(nhanesdesign,
(alldata$sex == 2) &
(alldata$shift_partners == i) &
(alldata$ct %in% c(1,2))
),
method = "beta"
))
print(100*attr(svyciprop(~(ct == 1),
design = subset(nhanesdesign,
(alldata$sex == 2) &
(alldata$shift_partners == i) &
(alldata$ct %in% c(1,2))
),
method = "beta"
), 'ci'
))
}
setwd("~/OneDrive - Imperial College London/backup/papers/reasons_and_venues/natsal3_ct_testing")
