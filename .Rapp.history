lines(c(1, 29), 100*c(0.043, 0.043), lty=2)
lines(c(1, 29), 100*c(0.023, 0.023))
plot(dt$X, 100*dt$Estimate, col = dt$Subset, xaxt = 'n', ylim=c(0,25), xlab = "", ylab = "Percentage")#
#
arrows(dt$X,#
	y0 = 100*dt$X2.5, y1 = 100*dt$X97.5,#
	col = dt$Subset,#
	code = 3, angle = 90, length = 0.05#
	)#
mtext("Education", side=1, line=1, at = 2.5, adj = 0.5)#
mtext("Elsewhere", side=1, line=1, at = 7.5, adj = 0.5)#
mtext("FP", side=1, line=1, at = 12.5, adj = 0.5)#
mtext("GP", side=1, line=1, at = 17.5, adj = 0.5)#
mtext("SH", side=1, line=1, at = 22.5, adj = 0.5)#
mtext("All venues", side=1, line=1, at = 27.5, adj = 0.5)#
#
mtext("Education", side=1, line=1, at = 32.5, adj = 0.5)#
mtext("Elsewhere", side=1, line=1, at = 37.5, adj = 0.5)#
mtext("FP", side=1, line=1, at = 42.5, adj = 0.5)#
mtext("GP", side=1, line=1, at = 47.5, adj = 0.5)#
mtext("SH", side=1, line=1, at = 52.5, adj = 0.5)#
mtext("All venues", side=1, line=1, at = 57.5, adj = 0.5)#
#
mtext("Women", side=1, line=3, at = 15, adj = 0.5)#
mtext("Men", side=1, line=3, at = 45, adj = 0.5)#
#
axis(side = 1, line = 2.5, at = c(1,29), labels = FALSE, tcl=0)#
axis(side = 1, line = 2.5, at = c(31,59), labels = FALSE, tcl=0)#
#
legend('topleft', inset = c(0.015,0.05),#
	col = 2:5,#
	pch = 1, lty = 1,#
	legend = c("All tested", "Reported NOT symptoms as reason for test", "Reported screening as reason for test", "Reported provider-initiated screening as reason for test")#
	)#
# lines for population prevalence#
lines(c(1, 29), 100*c(0.031, 0.031))#
lines(c(1, 29), 100*c(0.022, 0.022), lty=2)#
lines(c(1, 29), 100*c(0.043, 0.043), lty=2)#
#
lines(c(31, 59), 100*c(0.023, 0.023))#
lines(c(31, 59), 100*c(0.015, 0.015), lty=2)#
lines(c(31, 59), 100*c(0.034, 0.034), lty=2)
# Analysis of Natsal data to compare positivity among non-symptomatic testers with population prevalence.#
#
rm(list=ls())#
#
library(foreign)#
library(survey)#
library(vcd)#
#
source("/Users/Joanna/Documents/ct_trends/Natsal_symptoms_testing/my_barplot.R")#
#
natsal3 <- read.dta("~/Documents/Natsal-3/UKDA-7799-stata11/stata11/eul_natsal_2010_for_archive.dta")
#################################
# analysis on people who were tested for chlamydia#
#################################
#
# to be included in the subset tested for chlamydia in the last year, participants had to be:#
# sexually active (hetlife > 0 or samlife > 0)#
# aged < 45 (otherwise, were not asked whether they had tested)#
# EITHER diagnosed within the last year, OR reported testing within the last year#
tested <- natsal3[natsal3$hetlife >0 | natsal3$samlife > 0,]#
tested <- tested[tested$dage < 45,]#
tested <- tested[(tested$whnchlam == "Less than 1 year ago") | (tested$chlmtest == "Yes"),]#
#
##### restrict to 16-24-year-olds#
tested <- tested[tested$agrp == "16-24",]#
#
tested$why <- factor(NA, levels = levels(tested$chtstwy1))#
tested$why[!(tested$chtstwy1 %in% c("Not applicable", "Not answered"))] <- tested$chtstwy1[!(tested$chtstwy1 %in% c("Not applicable", "Not answered"))]#
tested$why[!(tested$chltstwy %in% c("Not applicable", "Not answered"))] <- tested$chltstwy[!(tested$chltstwy %in% c("Not applicable", "Not answered"))]#
tested$why <- droplevels(tested$why)#
#
tested$why2 <- NA#
tested$why2[tested$why == "I had symptoms"] <- "symptoms"#
tested$why2[tested$why %in% c("My partner had symptoms", "I was notified because a partner was diagnosed with Chlamydia")] <- "partner"#
tested$why2[tested$why == "Check up after previous positive test"] <- "re-test"#
tested$why2[tested$why %in% c("I wanted a general sexual health check-up", "I had no symptoms but I was worried about the risk of Chlamydia", "I was offered a routine test")] <- "screen"#
tested$why2[tested$why == "Other"] <- "other"#
tested$why2 <- factor(tested$why2, levels = names(table(tested$why2))[order(table(tested$why2), decreasing=TRUE)], ordered = TRUE)#
#
tested$why3 <- tested$why2#
tested$why3[tested$why2 %in% c("I wanted a general sexual health check-up", "I had no symptoms but I was worried about the risk of Chlamydia")] <- "screen - patient init"#
tested$why3[tested$why2 == "I was offered a routine test"] <- "screen - provider init"#
tested$why3 <- factor(tested$why3, levels = names(table(tested$why3))[order(table(tested$why3), decreasing=TRUE)], ordered = TRUE)#
#
tested$where <- factor(NA, levels = unique(c(levels(tested$chtstwh1), levels(tested$chltstwh))))#
tested$where[!(tested$chtstwh1 %in% c("Not applicable", "Not answered"))] <- tested$chtstwh1[!(tested$chtstwh1 %in% c("Not applicable", "Not answered"))]#
tested$where[!(tested$chltstwh %in% c("Not applicable", "Not answered"))] <- tested$chltstwh[!(tested$chltstwh %in% c("Not applicable", "Not answered"))]#
tested$where[tested$where == "NHS Family planning clinic / contraceptive clinic / reproductive health clinic"] <- "NHS FP clinic / contraceptive clinic / reproductive health clinic"#
tested$where <- droplevels(tested$where)#
#
tested$where2 <- NA#
tested$where2[tested$where == "Sexual health clinic (GUM clinic)"] <- "sexual health"#
tested$where2[tested$where == "General practice (GP) surgery"] <- "GP"#
tested$where2[tested$where == "NHS FP clinic / contraceptive clinic / reproductive health clinic"] <- "family planning"#
tested$where2[tested$where == "School / college / university"] <- "education"#
tested$where2[tested$where %in% c("Ante-natal Clinic / midwife", "Private non-NHS clinics or doctor", "Youth advisory clinic (e.g. Brook Clinic)", "Termination of pregnancy (abortion) clinic", "Hospital accident and emergency (A&E) department", "Pharmacy / chemist", "Internet", "Other non-health care place, e.g. youth club, festival, bar", "Somewhere else")] <- "elsewhere"#
#
tested$where2 <- factor(tested$where2, levels = names(table(tested$where2))[order(table(tested$where2), decreasing=TRUE)], ordered = TRUE)#
#
# set up survey design#
tdesign <- svydesign( #
		id = ~psu_scrm , #
		strata = ~stratagrp3 ,#
		data = tested ,		#
		weight = ~total_wt #
	)
venue_reason_table_m <- svytable(~ where2 + why3, design=subset(tdesign, rsex == "Male"), Ntotal = 1 )
venue_reason_table_f <- svytable(~ where2 + why3, design=subset(tdesign, rsex == "Female"), Ntotal = 1  )
###################
# nicer-looking plots#
###################
#
quartz(width=14, height=7)#
par(mfrow = c(1,2))#
#
#cols <- wes_palette(n=5, name="FantasticFox1")#
#cols <- c(rgb(202,86,112, maxColorValue = 256), rgb(114,165,85, maxColorValue = 256), rgb(171,98,192, maxColorValue = 256), rgb(197,124,60, maxColorValue = 256), rgb(99,140,204, maxColorValue = 256))#
cols <- c(rgb(0,169,189, maxColorValue = 256), rgb(255,54,99, maxColorValue = 256), rgb(76,62,193, maxColorValue = 256), rgb(106,163,0, maxColorValue = 256), rgb(129,62,70, maxColorValue = 256))#
#
my_barplot(#
	height = t(as.matrix(venue_reason_table_m)) / rep(apply(t(as.matrix(venue_reason_table_m)), 2, sum), each = 5), #
	width = svytable(~ where2, design=subset(tdesign, rsex == "Male"), Ntotal = 1 ),#
	horiz = TRUE, beside = FALSE, space = 0, col = cols,#
	xlim=c(0,1), ylim=c(0,1), #
	main = "Men (16-24 years)", axes=FALSE#
	)#
mtext("Men (16-24 years)", 3, line=1.5, cex=1.5)#
axis(1); mtext('Reason for test', 1, line=2)#
axis(2); mtext('Test venue', 2, line=2)
tested$why3 <- tested$why2#
tested$why3[tested$why %in% c("I wanted a general sexual health check-up", "I had no symptoms but I was worried about the risk of Chlamydia")] <- "screen - patient init"#
tested$why3[tested$why == "I was offered a routine test"] <- "screen - provider init"#
tested$why3 <- factor(tested$why3, levels = names(table(tested$why3))[order(table(tested$why3), decreasing=TRUE)], ordered = TRUE)#
#
tested$where <- factor(NA, levels = unique(c(levels(tested$chtstwh1), levels(tested$chltstwh))))#
tested$where[!(tested$chtstwh1 %in% c("Not applicable", "Not answered"))] <- tested$chtstwh1[!(tested$chtstwh1 %in% c("Not applicable", "Not answered"))]#
tested$where[!(tested$chltstwh %in% c("Not applicable", "Not answered"))] <- tested$chltstwh[!(tested$chltstwh %in% c("Not applicable", "Not answered"))]#
tested$where[tested$where == "NHS Family planning clinic / contraceptive clinic / reproductive health clinic"] <- "NHS FP clinic / contraceptive clinic / reproductive health clinic"#
tested$where <- droplevels(tested$where)#
#
tested$where2 <- NA#
tested$where2[tested$where == "Sexual health clinic (GUM clinic)"] <- "sexual health"#
tested$where2[tested$where == "General practice (GP) surgery"] <- "GP"#
tested$where2[tested$where == "NHS FP clinic / contraceptive clinic / reproductive health clinic"] <- "family planning"#
tested$where2[tested$where == "School / college / university"] <- "education"#
tested$where2[tested$where %in% c("Ante-natal Clinic / midwife", "Private non-NHS clinics or doctor", "Youth advisory clinic (e.g. Brook Clinic)", "Termination of pregnancy (abortion) clinic", "Hospital accident and emergency (A&E) department", "Pharmacy / chemist", "Internet", "Other non-health care place, e.g. youth club, festival, bar", "Somewhere else")] <- "elsewhere"#
#
tested$where2 <- factor(tested$where2, levels = names(table(tested$where2))[order(table(tested$where2), decreasing=TRUE)], ordered = TRUE)#
#
# set up survey design#
tdesign <- svydesign( #
		id = ~psu_scrm , #
		strata = ~stratagrp3 ,#
		data = tested ,		#
		weight = ~total_wt #
	)#
venue_reason_table_m <- svytable(~ where2 + why3, design=subset(tdesign, rsex == "Male"), Ntotal = 1 )#
#mosaic(venue_reason_table_m)#
#
venue_reason_table_f <- svytable(~ where2 + why3, design=subset(tdesign, rsex == "Female"), Ntotal = 1  )#
#mosaic(venue_reason_table_f)
#cols <- wes_palette(n=5, name="FantasticFox1")#
#cols <- c(rgb(202,86,112, maxColorValue = 256), rgb(114,165,85, maxColorValue = 256), rgb(171,98,192, maxColorValue = 256), rgb(197,124,60, maxColorValue = 256), rgb(99,140,204, maxColorValue = 256))#
cols <- c(rgb(0,169,189, maxColorValue = 256), rgb(255,54,99, maxColorValue = 256), rgb(76,62,193, maxColorValue = 256), rgb(106,163,0, maxColorValue = 256), rgb(129,62,70, maxColorValue = 256))#
#
my_barplot(#
	height = t(as.matrix(venue_reason_table_m)) / rep(apply(t(as.matrix(venue_reason_table_m)), 2, sum), each = 5), #
	width = svytable(~ where2, design=subset(tdesign, rsex == "Male"), Ntotal = 1 ),#
	horiz = TRUE, beside = FALSE, space = 0, col = cols,#
	xlim=c(0,1), ylim=c(0,1), #
	main = "Men (16-24 years)", axes=FALSE#
	)#
mtext("Men (16-24 years)", 3, line=1.5, cex=1.5)#
axis(1); mtext('Reason for test', 1, line=2)#
axis(2); mtext('Test venue', 2, line=2)#
#
legend('bottomleft', inset = c(0.03, 0.03), ncol = 5, pch = 15, col = cols, legend = levels(tested$why2), bg='white')#
my_barplot(#
	height = t(as.matrix(venue_reason_table_f)) / rep(apply(t(as.matrix(venue_reason_table_f)), 2, sum), each = 5), #
	width = svytable(~ where2, design=subset(tdesign, rsex == "Female"), Ntotal = 1 ),#
	horiz = TRUE, beside = FALSE, space = 0, col = cols,#
	xlim=c(0,1), ylim=c(0,1), #
	main = "Women (16-24 years)", axes = FALSE#
	)#
mtext("Women (16-24 years)", 3, line=1.5, cex=1.5)#
axis(1); mtext('Reason for test', 1, line=2)#
axis(2); mtext('Test venue', 2, line=2)#
#
legend('bottomleft', inset = c(0.03, 0.03), ncol=5, pch = 15, col = cols, legend = levels(tested$why2), bg='white')
###################
# nicer-looking plots#
###################
#
quartz(width=14, height=7)#
par(mfrow = c(1,2))#
#
#cols <- wes_palette(n=5, name="FantasticFox1")#
#cols <- c(rgb(202,86,112, maxColorValue = 256), rgb(114,165,85, maxColorValue = 256), rgb(171,98,192, maxColorValue = 256), rgb(197,124,60, maxColorValue = 256), rgb(99,140,204, maxColorValue = 256))#
cols <- c(rgb(0,169,189, maxColorValue = 256), rgb(255,54,99, maxColorValue = 256), rgb(76,62,193, maxColorValue = 256), rgb(106,163,0, maxColorValue = 256), rgb(129,62,70, maxColorValue = 256))#
#
my_barplot(#
	height = t(as.matrix(venue_reason_table_m)) / rep(apply(t(as.matrix(venue_reason_table_m)), 2, sum), each = 5), #
	width = svytable(~ where2, design=subset(tdesign, rsex == "Male"), Ntotal = 1 ),#
	horiz = TRUE, beside = FALSE, space = 0, col = cols,#
	xlim=c(0,1), ylim=c(0,1), #
	main = "Men (16-24 years)", axes=FALSE#
	)#
mtext("Men (16-24 years)", 3, line=1.5, cex=1.5)#
axis(1); mtext('Reason for test', 1, line=2)#
axis(2); mtext('Test venue', 2, line=2)#
#
legend('bottomleft', inset = c(0.03, 0.03), ncol = 5, pch = 15, col = cols, legend = levels(tested$why2), bg='white')
venue_reason_table_m <- svytable(~ where2 + why2, design=subset(tdesign, rsex == "Male"), Ntotal = 1 )
###################
# nicer-looking plots#
###################
#
quartz(width=14, height=7)#
par(mfrow = c(1,2))#
#
#cols <- wes_palette(n=5, name="FantasticFox1")#
#cols <- c(rgb(202,86,112, maxColorValue = 256), rgb(114,165,85, maxColorValue = 256), rgb(171,98,192, maxColorValue = 256), rgb(197,124,60, maxColorValue = 256), rgb(99,140,204, maxColorValue = 256))#
cols <- c(rgb(0,169,189, maxColorValue = 256), rgb(255,54,99, maxColorValue = 256), rgb(76,62,193, maxColorValue = 256), rgb(106,163,0, maxColorValue = 256), rgb(129,62,70, maxColorValue = 256))#
#
my_barplot(#
	height = t(as.matrix(venue_reason_table_m)) / rep(apply(t(as.matrix(venue_reason_table_m)), 2, sum), each = 5), #
	width = svytable(~ where2, design=subset(tdesign, rsex == "Male"), Ntotal = 1 ),#
	horiz = TRUE, beside = FALSE, space = 0, col = cols,#
	xlim=c(0,1), ylim=c(0,1), #
	main = "Men (16-24 years)", axes=FALSE#
	)#
mtext("Men (16-24 years)", 3, line=1.5, cex=1.5)#
axis(1); mtext('Reason for test', 1, line=2)#
axis(2); mtext('Test venue', 2, line=2)#
#
legend('bottomleft', inset = c(0.03, 0.03), ncol = 5, pch = 15, col = cols, legend = levels(tested$why2), bg='white')
# set up survey design#
tdesign <- svydesign( #
		id = ~psu_scrm , #
		strata = ~stratagrp3 ,#
		data = tested ,		#
		weight = ~total_wt #
	)#
venue_reason_table_m <- svytable(~ where2 + why2, design=subset(tdesign, rsex == "Male"), Ntotal = 1 )
venue_reason_table_m
# set up survey design#
tdesign <- svydesign( #
		id = ~psu_scrm , #
		strata = ~stratagrp3 ,#
		data = tested ,		#
		weight = ~total_wt #
	)#
venue_reason_table_m <- svytable(~ where2 + why3, design=subset(tdesign, rsex == "Male"), Ntotal = 1 )
venue_reason_table_m
table(tested$why3)
tested$why3 <- tested$why2
tested$why3[tested$why %in% c("I wanted a general sexual health check-up", "I had no symptoms but I was worried about the risk of Chlamydia")] <- "screen - patient init"
tested$why3 <- as.character(tested$why2)
tested$why3[tested$why %in% c("I wanted a general sexual health check-up", "I had no symptoms but I was worried about the risk of Chlamydia")] <- "screen - patient init"
tested$why3[tested$why == "I was offered a routine test"] <- "screen - provider init"
tested$why3 <- factor(tested$why3, levels = names(table(tested$why3))[order(table(tested$why3), decreasing=TRUE)], ordered = TRUE)
# set up survey design#
tdesign <- svydesign( #
		id = ~psu_scrm , #
		strata = ~stratagrp3 ,#
		data = tested ,		#
		weight = ~total_wt #
	)
venue_reason_table_m <- svytable(~ where2 + why3, design=subset(tdesign, rsex == "Male"), Ntotal = 1 )
venue_reason_table_m
###################
# nicer-looking plots#
###################
#
quartz(width=14, height=7)#
par(mfrow = c(1,2))#
#
#cols <- wes_palette(n=5, name="FantasticFox1")#
#cols <- c(rgb(202,86,112, maxColorValue = 256), rgb(114,165,85, maxColorValue = 256), rgb(171,98,192, maxColorValue = 256), rgb(197,124,60, maxColorValue = 256), rgb(99,140,204, maxColorValue = 256))#
cols <- c(rgb(0,169,189, maxColorValue = 256), rgb(255,54,99, maxColorValue = 256), rgb(76,62,193, maxColorValue = 256), rgb(106,163,0, maxColorValue = 256), rgb(129,62,70, maxColorValue = 256))#
#
my_barplot(#
	height = t(as.matrix(venue_reason_table_m)) / rep(apply(t(as.matrix(venue_reason_table_m)), 2, sum), each = 5), #
	width = svytable(~ where2, design=subset(tdesign, rsex == "Male"), Ntotal = 1 ),#
	horiz = TRUE, beside = FALSE, space = 0, col = cols,#
	xlim=c(0,1), ylim=c(0,1), #
	main = "Men (16-24 years)", axes=FALSE#
	)#
mtext("Men (16-24 years)", 3, line=1.5, cex=1.5)#
axis(1); mtext('Reason for test', 1, line=2)#
axis(2); mtext('Test venue', 2, line=2)#
#
legend('bottomleft', inset = c(0.03, 0.03), ncol = 5, pch = 15, col = cols, legend = levels(tested$why2), bg='white')
my_barplot(#
	height = t(as.matrix(venue_reason_table_m)) / rep(apply(t(as.matrix(venue_reason_table_m)), 2, sum), each = 6), #
	width = svytable(~ where2, design=subset(tdesign, rsex == "Male"), Ntotal = 1 ),#
	horiz = TRUE, beside = FALSE, space = 0, col = cols,#
	xlim=c(0,1), ylim=c(0,1), #
	main = "Men (16-24 years)", axes=FALSE#
	)
# Analysis of Natsal data to compare positivity among non-symptomatic testers with population prevalence.#
#
rm(list=ls())#
#
library(foreign)#
library(survey)#
library(vcd)#
#
source("/Users/Joanna/Documents/ct_trends/Natsal_symptoms_testing/my_barplot.R")#
#
natsal3 <- read.dta("~/Documents/Natsal-3/UKDA-7799-stata11/stata11/eul_natsal_2010_for_archive.dta")#
#
#################################
# analysis on people who were tested for chlamydia#
#################################
#
# to be included in the subset tested for chlamydia in the last year, participants had to be:#
# sexually active (hetlife > 0 or samlife > 0)#
# aged < 45 (otherwise, were not asked whether they had tested)#
# EITHER diagnosed within the last year, OR reported testing within the last year#
tested <- natsal3[natsal3$hetlife >0 | natsal3$samlife > 0,]#
tested <- tested[tested$dage < 45,]#
tested <- tested[(tested$whnchlam == "Less than 1 year ago") | (tested$chlmtest == "Yes"),]#
#
##### restrict to 16-24-year-olds#
tested <- tested[tested$agrp == "16-24",]#
#
tested$why <- factor(NA, levels = levels(tested$chtstwy1))#
tested$why[!(tested$chtstwy1 %in% c("Not applicable", "Not answered"))] <- tested$chtstwy1[!(tested$chtstwy1 %in% c("Not applicable", "Not answered"))]#
tested$why[!(tested$chltstwy %in% c("Not applicable", "Not answered"))] <- tested$chltstwy[!(tested$chltstwy %in% c("Not applicable", "Not answered"))]#
tested$why <- droplevels(tested$why)#
#
tested$why2 <- NA#
tested$why2[tested$why == "I had symptoms"] <- "symptoms"#
tested$why2[tested$why %in% c("My partner had symptoms", "I was notified because a partner was diagnosed with Chlamydia")] <- "partner"#
tested$why2[tested$why == "Check up after previous positive test"] <- "re-test"#
tested$why2[tested$why %in% c("I wanted a general sexual health check-up", "I had no symptoms but I was worried about the risk of Chlamydia", "I was offered a routine test")] <- "screen"#
tested$why2[tested$why == "Other"] <- "other"#
tested$why2 <- factor(tested$why2, levels = names(table(tested$why2))[order(table(tested$why2), decreasing=TRUE)], ordered = TRUE)#
#
tested$why3 <- as.character(tested$why2)#
tested$why3[tested$why %in% c("I wanted a general sexual health check-up", "I had no symptoms but I was worried about the risk of Chlamydia")] <- "screen - patient init"#
tested$why3[tested$why == "I was offered a routine test"] <- "screen - provider init"#
tested$why3 <- factor(tested$why3, levels = names(table(tested$why3))[order(table(tested$why3), decreasing=TRUE)], ordered = TRUE)#
#
tested$where <- factor(NA, levels = unique(c(levels(tested$chtstwh1), levels(tested$chltstwh))))#
tested$where[!(tested$chtstwh1 %in% c("Not applicable", "Not answered"))] <- tested$chtstwh1[!(tested$chtstwh1 %in% c("Not applicable", "Not answered"))]#
tested$where[!(tested$chltstwh %in% c("Not applicable", "Not answered"))] <- tested$chltstwh[!(tested$chltstwh %in% c("Not applicable", "Not answered"))]#
tested$where[tested$where == "NHS Family planning clinic / contraceptive clinic / reproductive health clinic"] <- "NHS FP clinic / contraceptive clinic / reproductive health clinic"#
tested$where <- droplevels(tested$where)#
#
tested$where2 <- NA#
tested$where2[tested$where == "Sexual health clinic (GUM clinic)"] <- "sexual health"#
tested$where2[tested$where == "General practice (GP) surgery"] <- "GP"#
tested$where2[tested$where == "NHS FP clinic / contraceptive clinic / reproductive health clinic"] <- "family planning"#
tested$where2[tested$where == "School / college / university"] <- "education"#
tested$where2[tested$where %in% c("Ante-natal Clinic / midwife", "Private non-NHS clinics or doctor", "Youth advisory clinic (e.g. Brook Clinic)", "Termination of pregnancy (abortion) clinic", "Hospital accident and emergency (A&E) department", "Pharmacy / chemist", "Internet", "Other non-health care place, e.g. youth club, festival, bar", "Somewhere else")] <- "elsewhere"#
#
tested$where2 <- factor(tested$where2, levels = names(table(tested$where2))[order(table(tested$where2), decreasing=TRUE)], ordered = TRUE)#
#
# set up survey design#
tdesign <- svydesign( #
		id = ~psu_scrm , #
		strata = ~stratagrp3 ,#
		data = tested ,		#
		weight = ~total_wt #
	)#
venue_reason_table_m <- svytable(~ where2 + why2, design=subset(tdesign, rsex == "Male"), Ntotal = 1 )#
#mosaic(venue_reason_table_m)#
#
venue_reason_table_f <- svytable(~ where2 + why3, design=subset(tdesign, rsex == "Female"), Ntotal = 1  )#
#mosaic(venue_reason_table_f)
###################
# nicer-looking plots#
###################
#
quartz(width=14, height=7)#
par(mfrow = c(1,2))#
#
#cols <- wes_palette(n=5, name="FantasticFox1")#
#cols <- c(rgb(202,86,112, maxColorValue = 256), rgb(114,165,85, maxColorValue = 256), rgb(171,98,192, maxColorValue = 256), rgb(197,124,60, maxColorValue = 256), rgb(99,140,204, maxColorValue = 256))#
cols <- c(rgb(0,169,189, maxColorValue = 256), rgb(255,54,99, maxColorValue = 256), rgb(76,62,193, maxColorValue = 256), rgb(106,163,0, maxColorValue = 256), rgb(129,62,70, maxColorValue = 256))#
#
my_barplot(#
	height = t(as.matrix(venue_reason_table_m)) / rep(apply(t(as.matrix(venue_reason_table_m)), 2, sum), each = 6), #
	width = svytable(~ where2, design=subset(tdesign, rsex == "Male"), Ntotal = 1 ),#
	horiz = TRUE, beside = FALSE, space = 0, col = cols,#
	xlim=c(0,1), ylim=c(0,1), #
	main = "Men (16-24 years)", axes=FALSE#
	)#
mtext("Men (16-24 years)", 3, line=1.5, cex=1.5)#
axis(1); mtext('Reason for test', 1, line=2)#
axis(2); mtext('Test venue', 2, line=2)#
#
legend('bottomleft', inset = c(0.03, 0.03), ncol = 5, pch = 15, col = cols, legend = levels(tested$why2), bg='white')
t(as.matrix(venue_reason_table_m)) / rep(apply(t(as.matrix(venue_reason_table_m)), 2, sum), each = 6)
as.matrix(venue_reason_table_m))
t(as.matrix(venue_reason_table_m))
rep(apply(t(as.matrix(venue_reason_table_m)), 2, sum), each = 6)
venue_reason_table_m <- svytable(~ where2 + why3, design=subset(tdesign, rsex == "Male"), Ntotal = 1 )
my_barplot(#
	height = t(as.matrix(venue_reason_table_m)) / rep(apply(t(as.matrix(venue_reason_table_m)), 2, sum), each = 6), #
	width = svytable(~ where2, design=subset(tdesign, rsex == "Male"), Ntotal = 1 ),#
	horiz = TRUE, beside = FALSE, space = 0, col = cols,#
	xlim=c(0,1), ylim=c(0,1), #
	main = "Men (16-24 years)", axes=FALSE#
	)
mtext("Men (16-24 years)", 3, line=1.5, cex=1.5)#
axis(1); mtext('Reason for test', 1, line=2)#
axis(2); mtext('Test venue', 2, line=2)#
#
legend('bottomleft', inset = c(0.03, 0.03), ncol = 5, pch = 15, col = cols, legend = levels(tested$why2), bg='white')
my_barplot(#
	height = t(as.matrix(venue_reason_table_f)) / rep(apply(t(as.matrix(venue_reason_table_f)), 2, sum), each = 5), #
	width = svytable(~ where2, design=subset(tdesign, rsex == "Female"), Ntotal = 1 ),#
	horiz = TRUE, beside = FALSE, space = 0, col = cols,#
	xlim=c(0,1), ylim=c(0,1), #
	main = "Women (16-24 years)", axes = FALSE#
	)#
mtext("Women (16-24 years)", 3, line=1.5, cex=1.5)#
axis(1); mtext('Reason for test', 1, line=2)#
axis(2); mtext('Test venue', 2, line=2)#
#
legend('bottomleft', inset = c(0.03, 0.03), ncol=5, pch = 15, col = cols, legend = levels(tested$why2), bg='white')
my_barplot(#
	height = t(as.matrix(venue_reason_table_f)) / rep(apply(t(as.matrix(venue_reason_table_f)), 2, sum), each = 6), #
	width = svytable(~ where2, design=subset(tdesign, rsex == "Female"), Ntotal = 1 ),#
	horiz = TRUE, beside = FALSE, space = 0, col = cols,#
	xlim=c(0,1), ylim=c(0,1), #
	main = "Women (16-24 years)", axes = FALSE#
	)#
mtext("Women (16-24 years)", 3, line=1.5, cex=1.5)#
axis(1); mtext('Reason for test', 1, line=2)#
axis(2); mtext('Test venue', 2, line=2)#
#
legend('bottomleft', inset = c(0.03, 0.03), ncol=5, pch = 15, col = cols, legend = levels(tested$why2), bg='white')
###################
# nicer-looking plots#
###################
#
quartz(width=14, height=7)#
par(mfrow = c(1,2))#
#
#cols <- wes_palette(n=5, name="FantasticFox1")#
#cols <- c(rgb(202,86,112, maxColorValue = 256), rgb(114,165,85, maxColorValue = 256), rgb(171,98,192, maxColorValue = 256), rgb(197,124,60, maxColorValue = 256), rgb(99,140,204, maxColorValue = 256))#
cols <- c(rgb(0,169,189, maxColorValue = 256), rgb(255,54,99, maxColorValue = 256), rgb(76,62,193, maxColorValue = 256), rgb(106,163,0, maxColorValue = 256), rgb(129,62,70, maxColorValue = 256))#
#
my_barplot(#
	height = t(as.matrix(venue_reason_table_m)) / rep(apply(t(as.matrix(venue_reason_table_m)), 2, sum), each = 6), #
	width = svytable(~ where2, design=subset(tdesign, rsex == "Male"), Ntotal = 1 ),#
	horiz = TRUE, beside = FALSE, space = 0, col = cols,#
	xlim=c(0,1), ylim=c(0,1), #
	main = "Men (16-24 years)", axes=FALSE#
	)#
mtext("Men (16-24 years)", 3, line=1.5, cex=1.5)#
axis(1); mtext('Reason for test', 1, line=2)#
axis(2); mtext('Test venue', 2, line=2)#
#
legend('bottomleft', inset = c(0.03, 0.03), ncol = 5, pch = 15, col = cols, legend = levels(tested$why2), bg='white')#
my_barplot(#
	height = t(as.matrix(venue_reason_table_f)) / rep(apply(t(as.matrix(venue_reason_table_f)), 2, sum), each = 6), #
	width = svytable(~ where2, design=subset(tdesign, rsex == "Female"), Ntotal = 1 ),#
	horiz = TRUE, beside = FALSE, space = 0, col = cols,#
	xlim=c(0,1), ylim=c(0,1), #
	main = "Women (16-24 years)", axes = FALSE#
	)#
mtext("Women (16-24 years)", 3, line=1.5, cex=1.5)#
axis(1); mtext('Reason for test', 1, line=2)#
axis(2); mtext('Test venue', 2, line=2)#
#
legend('bottomleft', inset = c(0.03, 0.03), ncol=5, pch = 15, col = cols, legend = levels(tested$why2), bg='white')
table(tested$where2, tested$why2, tested$rsex)
table(tested$where2, tested$why3, tested$rsex)
cols <- wes_palette("IsleofDogs1") # 6 colours
my_barplot(#
	height = t(as.matrix(venue_reason_table_m)) / rep(apply(t(as.matrix(venue_reason_table_m)), 2, sum), each = 6), #
	width = svytable(~ where2, design=subset(tdesign, rsex == "Male"), Ntotal = 1 ),#
	horiz = TRUE, beside = FALSE, space = 0, col = cols,#
	xlim=c(0,1), ylim=c(0,1), #
	main = "Men (16-24 years)", axes=FALSE#
	)#
mtext("Men (16-24 years)", 3, line=1.5, cex=1.5)#
axis(1); mtext('Reason for test', 1, line=2)#
axis(2); mtext('Test venue', 2, line=2)
legend('bottomleft', inset = c(0.03, 0.03), ncol = 5, pch = 15, col = cols, legend = levels(tested$why2), bg='white')#
my_barplot(#
	height = t(as.matrix(venue_reason_table_f)) / rep(apply(t(as.matrix(venue_reason_table_f)), 2, sum), each = 6), #
	width = svytable(~ where2, design=subset(tdesign, rsex == "Female"), Ntotal = 1 ),#
	horiz = TRUE, beside = FALSE, space = 0, col = cols,#
	xlim=c(0,1), ylim=c(0,1), #
	main = "Women (16-24 years)", axes = FALSE#
	)#
mtext("Women (16-24 years)", 3, line=1.5, cex=1.5)#
axis(1); mtext('Reason for test', 1, line=2)#
axis(2); mtext('Test venue', 2, line=2)#
#
legend('bottomleft', inset = c(0.03, 0.03), ncol=5, pch = 15, col = cols, legend = levels(tested$why2), bg='white')
legend('bottomleft', inset = c(0.03, 0.03), ncol = 6, pch = 15, col = cols, legend = levels(tested$why3), bg='white')
###################
# nicer-looking plots#
###################
#
quartz(width=14, height=7)#
par(mfrow = c(1,2))#
#
#cols <- wes_palette(n=5, name="FantasticFox1")#
#cols <- c(rgb(202,86,112, maxColorValue = 256), rgb(114,165,85, maxColorValue = 256), rgb(171,98,192, maxColorValue = 256), rgb(197,124,60, maxColorValue = 256), rgb(99,140,204, maxColorValue = 256))#
#cols <- c(rgb(0,169,189, maxColorValue = 256), rgb(255,54,99, maxColorValue = 256), rgb(76,62,193, maxColorValue = 256), rgb(106,163,0, maxColorValue = 256), rgb(129,62,70, maxColorValue = 256))#
cols <- wes_palette("IsleofDogs1") # 6 colours#
my_barplot(#
	height = t(as.matrix(venue_reason_table_m)) / rep(apply(t(as.matrix(venue_reason_table_m)), 2, sum), each = 6), #
	width = svytable(~ where2, design=subset(tdesign, rsex == "Male"), Ntotal = 1 ),#
	horiz = TRUE, beside = FALSE, space = 0, col = cols,#
	xlim=c(0,1), ylim=c(0,1), #
	main = "Men (16-24 years)", axes=FALSE#
	)#
mtext("Men (16-24 years)", 3, line=1.5, cex=1.5)#
axis(1); mtext('Reason for test', 1, line=2)#
axis(2); mtext('Test venue', 2, line=2)#
#
legend('bottomleft', inset = c(0.03, 0.03), ncol = 3, pch = 15, col = cols, legend = levels(tested$why3), bg='white')
legend('bottomleft', inset = c(0.03, 0.03), ncol = 2, pch = 15, col = cols, legend = levels(tested$why3), bg='white')
###################
# nicer-looking plots#
###################
#
quartz(width=14, height=7)#
par(mfrow = c(1,2))#
#
#cols <- wes_palette(n=5, name="FantasticFox1")#
#cols <- c(rgb(202,86,112, maxColorValue = 256), rgb(114,165,85, maxColorValue = 256), rgb(171,98,192, maxColorValue = 256), rgb(197,124,60, maxColorValue = 256), rgb(99,140,204, maxColorValue = 256))#
#cols <- c(rgb(0,169,189, maxColorValue = 256), rgb(255,54,99, maxColorValue = 256), rgb(76,62,193, maxColorValue = 256), rgb(106,163,0, maxColorValue = 256), rgb(129,62,70, maxColorValue = 256))#
cols <- wes_palette("IsleofDogs1") # 6 colours#
my_barplot(#
	height = t(as.matrix(venue_reason_table_m)) / rep(apply(t(as.matrix(venue_reason_table_m)), 2, sum), each = 6), #
	width = svytable(~ where2, design=subset(tdesign, rsex == "Male"), Ntotal = 1 ),#
	horiz = TRUE, beside = FALSE, space = 0, col = cols,#
	xlim=c(0,1), ylim=c(0,1), #
	main = "Men (16-24 years)", axes=FALSE#
	)#
mtext("Men (16-24 years)", 3, line=1.5, cex=1.5)#
axis(1); mtext('Reason for test', 1, line=2)#
axis(2); mtext('Test venue', 2, line=2)#
#
legend('bottomleft', inset = c(0.03, 0.03), ncol = 3, pch = 15, col = cols, legend = levels(tested$why3), bg='white')#
my_barplot(#
	height = t(as.matrix(venue_reason_table_f)) / rep(apply(t(as.matrix(venue_reason_table_f)), 2, sum), each = 6), #
	width = svytable(~ where2, design=subset(tdesign, rsex == "Female"), Ntotal = 1 ),#
	horiz = TRUE, beside = FALSE, space = 0, col = cols,#
	xlim=c(0,1), ylim=c(0,1), #
	main = "Women (16-24 years)", axes = FALSE#
	)#
mtext("Women (16-24 years)", 3, line=1.5, cex=1.5)#
axis(1); mtext('Reason for test', 1, line=2)#
axis(2); mtext('Test venue', 2, line=2)#
#
legend('bottomleft', inset = c(0.03, 0.03), ncol = 3, pch = 15, col = cols, legend = levels(tested$why3), bg='white')
###################
# nicer-looking plots#
###################
#
quartz(width=14, height=7)#
par(mfrow = c(1,2))#
#
#cols <- wes_palette(n=5, name="FantasticFox1")#
#cols <- c(rgb(202,86,112, maxColorValue = 256), rgb(114,165,85, maxColorValue = 256), rgb(171,98,192, maxColorValue = 256), rgb(197,124,60, maxColorValue = 256), rgb(99,140,204, maxColorValue = 256))#
#cols <- c(rgb(0,169,189, maxColorValue = 256), rgb(255,54,99, maxColorValue = 256), rgb(76,62,193, maxColorValue = 256), rgb(106,163,0, maxColorValue = 256), rgb(129,62,70, maxColorValue = 256))#
cols <- wes_palette("IsleofDogs1") # 6 colours#
my_barplot(#
	height = t(as.matrix(venue_reason_table_m)) / rep(apply(t(as.matrix(venue_reason_table_m)), 2, sum), each = 6), #
	width = svytable(~ where2, design=subset(tdesign, rsex == "Male"), Ntotal = 1 ),#
	horiz = TRUE, beside = FALSE, space = 0, col = cols,#
	xlim=c(0,1), ylim=c(0,1), #
	main = "Men (16-24 years)", axes=FALSE#
	)#
mtext("Men (16-24 years)", 3, line=1.5, cex=1.5)#
axis(1); mtext('Reason for test', 1, line=2)#
axis(2); mtext('Test venue', 2, line=2)#
#
legend('bottomleft', inset = c(0.01, 0.01), ncol = 3, pch = 15, col = cols, legend = levels(tested$why3), bg='white')#
my_barplot(#
	height = t(as.matrix(venue_reason_table_f)) / rep(apply(t(as.matrix(venue_reason_table_f)), 2, sum), each = 6), #
	width = svytable(~ where2, design=subset(tdesign, rsex == "Female"), Ntotal = 1 ),#
	horiz = TRUE, beside = FALSE, space = 0, col = cols,#
	xlim=c(0,1), ylim=c(0,1), #
	main = "Women (16-24 years)", axes = FALSE#
	)#
mtext("Women (16-24 years)", 3, line=1.5, cex=1.5)#
axis(1); mtext('Reason for test', 1, line=2)#
axis(2); mtext('Test venue', 2, line=2)#
#
legend('bottomleft', inset = c(0.01, 0.01), ncol = 3, pch = 15, col = cols, legend = levels(tested$why3), bg='white')
venue_reason_table_m <- svytable(~ where2 + why3, design=subset(tdesign, rsex == "Male"), Ntotal = 1 )
venue_reason_table_m
100*venue_reason_table_m
apply(100*venue_reason_table_m,2,sum)
apply(100*venue_reason_table_m,1,sum)
sum(apply(100*venue_reason_table_m,1,sum))
apply(100*venue_reason_table_m,2,sum)
sum(apply(100*venue_reason_table_m,2,sum))
100*venue_reason_table_f
apply(100*venue_reason_table_f,2,sum)
sum(apply(100*venue_reason_table_f,2,sum))
apply(100*venue_reason_table_f,1,sum)
# Analysis of Natsal data to compare positivity among non-symptomatic testers with population prevalence.#
#
rm(list=ls())#
#
library(foreign)#
library(survey)#
#
natsal3 <- read.dta("~/Documents/Natsal-3/UKDA-7799-stata11/stata11/eul_natsal_2010_for_archive.dta")#
#
#################################
# analysis on people who were tested for chlamydia#
#################################
#
# to be included in the subset tested for chlamydia in the last year, participants had to be:#
# sexually active (hetlife > 0 or samlife > 0)#
# aged < 45 (otherwise, were not asked whether they had tested)#
# EITHER diagnosed within the last year, OR reported testing within the last year#
tested <- natsal3[natsal3$hetlife >0 | natsal3$samlife > 0,]#
tested <- tested[tested$dage < 45,]#
tested <- tested[(tested$whnchlam == "Less than 1 year ago") | (tested$chlmtest == "Yes"),]#
#
# set up survey design#
tdesign <- svydesign( #
		id = ~psu_scrm , #
		strata = ~stratagrp3 ,#
		data = tested ,		#
		weight = ~total_wt #
	)#
#
# proportion of those tested in the last year who were infected#
svyciprop(~(whnchlam == "Less than 1 year ago"),#
	design = tdesign#
	)#
#
svyciprop(~(whnchlam == "Less than 1 year ago"),#
	design = subset(tdesign, rsex == "Male")#
	)#
svyciprop(~(whnchlam == "Less than 1 year ago"),#
	design = subset(tdesign, rsex == "Female")#
	)#
for(i in unique(tested$rsex)){#
	for(j in unique(tested$agrp)){#
		print(c(i,j))#
		print(svyciprop(~(whnchlam == "Less than 1 year ago"),#
			design = subset(tdesign, rsex == i & agrp == j)#
			))#
	}#
}
###############################################
# plots (from csv file)#
###############################################
#
dt <- read.csv("~/Documents/ct_trends/Natsal_symptoms_testing/positivity_by_venue_reason_3.csv")#
#
quartz(width=18, height=6)#
plot(dt$X, 100*dt$Estimate, col = dt$Subset, xaxt = 'n', ylim=c(0,25), xlab = "", ylab = "Percentage")#
#
arrows(dt$X,#
	y0 = 100*dt$X2.5, y1 = 100*dt$X97.5,#
	col = dt$Subset,#
	code = 3, angle = 90, length = 0.05#
	)
dt
mtext("All venues", side=1, line=1, at = 2.5, adj = 0.5)#
mtext("Sexual Health", side=1, line=1, at = 7.5, adj = 0.5)#
mtext("GP", side=1, line=1, at = 12.5, adj = 0.5)#
mtext("Education", side=1, line=1, at = 17.5, adj = 0.5)#
mtext("Family Planning", side=1, line=1, at = 22.5, adj = 0.5)#
mtext("Elsewhere", side=1, line=1, at = 27.5, adj = 0.5)
mtext("All venues", side=1, line=1, at = 32.5, adj = 0.5)#
mtext("Sexual Health", side=1, line=1, at = 37.5, adj = 0.5)#
mtext("GP", side=1, line=1, at = 42.5, adj = 0.5)#
mtext("Education", side=1, line=1, at = 47.5, adj = 0.5)#
mtext("Family Planning", side=1, line=1, at = 52.5, adj = 0.5)#
mtext("Elsewhere", side=1, line=1, at = 57.5, adj = 0.5)
mtext("Women", side=1, line=3, at = 15, adj = 0.5)
mtext("Men", side=1, line=3, at = 45, adj = 0.5)
axis(side = 1, line = 2.5, at = c(1,29), labels = FALSE, tcl=0)#
axis(side = 1, line = 2.5, at = c(31,59), labels = FALSE, tcl=0)
legend('topleft', inset = c(0.015,0.05),#
	col = 2:5,#
	pch = 1, lty = 1,#
	legend = c("All tested", "Reported NOT symptoms as reason for test", "Reported screening as reason for test", "Reported provider-initiated screening as reason for test")#
	)
# lines for population prevalence#
lines(c(1, 29), 100*c(0.031, 0.031))#
lines(c(1, 29), 100*c(0.022, 0.022), lty=2)#
lines(c(1, 29), 100*c(0.043, 0.043), lty=2)#
#
lines(c(31, 59), 100*c(0.023, 0.023))#
lines(c(31, 59), 100*c(0.015, 0.015), lty=2)#
lines(c(31, 59), 100*c(0.034, 0.034), lty=2)
legend('topleft', inset = c(0.15,0.05),#
	col = 2:5,#
	pch = 1, lty = 1,#
	legend = c("All tested", "Reported NOT symptoms as reason for test", "Reported screening as reason for test", "Reported provider-initiated screening as reason for test")#
	)
###############################################
# plots (from csv file)#
###############################################
#
dt <- read.csv("~/Documents/ct_trends/Natsal_symptoms_testing/positivity_by_venue_reason_3.csv")#
#
quartz(width=18, height=6)#
plot(dt$X, 100*dt$Estimate, col = dt$Subset, xaxt = 'n', ylim=c(0,25), xlab = "", ylab = "Percentage")#
#
arrows(dt$X,#
	y0 = 100*dt$X2.5, y1 = 100*dt$X97.5,#
	col = dt$Subset,#
	code = 3, angle = 90, length = 0.05#
	)#
mtext("All venues", side=1, line=1, at = 2.5, adj = 0.5)#
mtext("Sexual Health", side=1, line=1, at = 7.5, adj = 0.5)#
mtext("GP", side=1, line=1, at = 12.5, adj = 0.5)#
mtext("Education", side=1, line=1, at = 17.5, adj = 0.5)#
mtext("Family Planning", side=1, line=1, at = 22.5, adj = 0.5)#
mtext("Elsewhere", side=1, line=1, at = 27.5, adj = 0.5)#
#
mtext("All venues", side=1, line=1, at = 32.5, adj = 0.5)#
mtext("Sexual Health", side=1, line=1, at = 37.5, adj = 0.5)#
mtext("GP", side=1, line=1, at = 42.5, adj = 0.5)#
mtext("Education", side=1, line=1, at = 47.5, adj = 0.5)#
mtext("Family Planning", side=1, line=1, at = 52.5, adj = 0.5)#
mtext("Elsewhere", side=1, line=1, at = 57.5, adj = 0.5)#
#
mtext("Women", side=1, line=3, at = 15, adj = 0.5)#
mtext("Men", side=1, line=3, at = 45, adj = 0.5)#
#
axis(side = 1, line = 2.5, at = c(1,29), labels = FALSE, tcl=0)#
axis(side = 1, line = 2.5, at = c(31,59), labels = FALSE, tcl=0)#
#
legend('topleft', inset = c(0.15,0.05),#
	col = 2:5,#
	pch = 1, lty = 1,#
	legend = c("All tested", "Reported NOT symptoms as reason for test", "Reported screening as reason for test", "Reported provider-initiated screening as reason for test")#
	)#
# lines for population prevalence#
lines(c(1, 29), 100*c(0.031, 0.031))#
lines(c(1, 29), 100*c(0.022, 0.022), lty=2)#
lines(c(1, 29), 100*c(0.043, 0.043), lty=2)#
#
lines(c(31, 59), 100*c(0.023, 0.023))#
lines(c(31, 59), 100*c(0.015, 0.015), lty=2)#
lines(c(31, 59), 100*c(0.034, 0.034), lty=2)
plot(dt$X, 100*dt$Estimate, col = dt$Subset, pch = dt$subset - 1, xaxt = 'n', ylim=c(0,25), xlab = "", ylab = "Percentage")
plot(dt$X, 100*dt$Estimate, col = dt$Subset, pch = dt$Subset - 1, xaxt = 'n', ylim=c(0,25), xlab = "", ylab = "Percentage")
plot(dt$X, 100*dt$Estimate, col = dt$Subset, pch = dt$Subset, xaxt = 'n', ylim=c(0,25), xlab = "", ylab = "Percentage")
plot(dt$X, 100*dt$Estimate, col = dt$Subset, pch = as.numeric(dt$Subset), xaxt = 'n', ylim=c(0,25), xlab = "", ylab = "Percentage")
plot(dt$X, 100*dt$Estimate, col = dt$Subset, pch = as.numeric(dt$Subset)-1, xaxt = 'n', ylim=c(0,25), xlab = "", ylab = "Percentage")
arrows(dt$X,#
	y0 = 100*dt$X2.5, y1 = 100*dt$X97.5,#
	col = dt$Subset,#
	code = 3, angle = 90, length = 0.05#
	)
mtext("All venues", side=1, line=1, at = 2.5, adj = 0.5)#
mtext("Sexual Health", side=1, line=1, at = 7.5, adj = 0.5)#
mtext("GP", side=1, line=1, at = 12.5, adj = 0.5)#
mtext("Education", side=1, line=1, at = 17.5, adj = 0.5)#
mtext("Family Planning", side=1, line=1, at = 22.5, adj = 0.5)#
mtext("Elsewhere", side=1, line=1, at = 27.5, adj = 0.5)#
#
mtext("All venues", side=1, line=1, at = 32.5, adj = 0.5)#
mtext("Sexual Health", side=1, line=1, at = 37.5, adj = 0.5)#
mtext("GP", side=1, line=1, at = 42.5, adj = 0.5)#
mtext("Education", side=1, line=1, at = 47.5, adj = 0.5)#
mtext("Family Planning", side=1, line=1, at = 52.5, adj = 0.5)#
mtext("Elsewhere", side=1, line=1, at = 57.5, adj = 0.5)#
#
mtext("Women", side=1, line=3, at = 15, adj = 0.5)#
mtext("Men", side=1, line=3, at = 45, adj = 0.5)#
#
axis(side = 1, line = 2.5, at = c(1,29), labels = FALSE, tcl=0)#
axis(side = 1, line = 2.5, at = c(31,59), labels = FALSE, tcl=0)
legend('topleft', inset = c(0.15,0.05),#
	col = 2:5,#
	pch = 1:4, lty = 1,#
	legend = c("All tested", "Reported NOT symptoms as reason for test", "Reported screening as reason for test", "Reported provider-initiated screening as reason for test")#
	)
# lines for population prevalence#
lines(c(1, 29), 100*c(0.031, 0.031))#
lines(c(1, 29), 100*c(0.022, 0.022), lty=2)#
lines(c(1, 29), 100*c(0.043, 0.043), lty=2)#
#
lines(c(31, 59), 100*c(0.023, 0.023))#
lines(c(31, 59), 100*c(0.015, 0.015), lty=2)#
lines(c(31, 59), 100*c(0.034, 0.034), lty=2)
quartz(width=18, height=6)#
plot(dt$X, 100*dt$Estimate, #col = dt$Subset, #
pch = as.numeric(dt$Subset)-1, xaxt = 'n', ylim=c(0,25), xlab = "", ylab = "Percentage")#
#
arrows(dt$X,#
	y0 = 100*dt$X2.5, y1 = 100*dt$X97.5,#
	col = dt$Subset,#
	code = 3, angle = 90, length = 0.05#
	)#
mtext("All venues", side=1, line=1, at = 2.5, adj = 0.5)#
mtext("Sexual Health", side=1, line=1, at = 7.5, adj = 0.5)#
mtext("GP", side=1, line=1, at = 12.5, adj = 0.5)#
mtext("Education", side=1, line=1, at = 17.5, adj = 0.5)#
mtext("Family Planning", side=1, line=1, at = 22.5, adj = 0.5)#
mtext("Elsewhere", side=1, line=1, at = 27.5, adj = 0.5)#
#
mtext("All venues", side=1, line=1, at = 32.5, adj = 0.5)#
mtext("Sexual Health", side=1, line=1, at = 37.5, adj = 0.5)#
mtext("GP", side=1, line=1, at = 42.5, adj = 0.5)#
mtext("Education", side=1, line=1, at = 47.5, adj = 0.5)#
mtext("Family Planning", side=1, line=1, at = 52.5, adj = 0.5)#
mtext("Elsewhere", side=1, line=1, at = 57.5, adj = 0.5)#
#
mtext("Women", side=1, line=3, at = 15, adj = 0.5)#
mtext("Men", side=1, line=3, at = 45, adj = 0.5)#
#
axis(side = 1, line = 2.5, at = c(1,29), labels = FALSE, tcl=0)#
axis(side = 1, line = 2.5, at = c(31,59), labels = FALSE, tcl=0)#
#
legend('topleft', inset = c(0.15,0.05),#
	col = 2:5,#
	pch = 1:4, lty = 1,#
	legend = c("All tested", "Reported NOT symptoms as reason for test", "Reported screening as reason for test", "Reported provider-initiated screening as reason for test")#
	)#
# lines for population prevalence#
lines(c(1, 29), 100*c(0.031, 0.031))#
lines(c(1, 29), 100*c(0.022, 0.022), lty=2)#
lines(c(1, 29), 100*c(0.043, 0.043), lty=2)#
#
lines(c(31, 59), 100*c(0.023, 0.023))#
lines(c(31, 59), 100*c(0.015, 0.015), lty=2)#
lines(c(31, 59), 100*c(0.034, 0.034), lty=2)
###############################################
# plots (from csv file)#
###############################################
#
dt <- read.csv("~/Documents/ct_trends/Natsal_symptoms_testing/positivity_by_venue_reason_3.csv")#
#
quartz(width=18, height=6)#
plot(dt$X, 100*dt$Estimate, #col = dt$Subset, #
pch = as.numeric(dt$Subset)-1, xaxt = 'n', ylim=c(0,25), xlab = "", ylab = "Percentage")#
#
arrows(dt$X,#
	y0 = 100*dt$X2.5, y1 = 100*dt$X97.5,#
#	col = dt$Subset,#
	code = 3, angle = 90, length = 0.05#
	)#
mtext("All venues", side=1, line=1, at = 2.5, adj = 0.5)#
mtext("Sexual Health", side=1, line=1, at = 7.5, adj = 0.5)#
mtext("GP", side=1, line=1, at = 12.5, adj = 0.5)#
mtext("Education", side=1, line=1, at = 17.5, adj = 0.5)#
mtext("Family Planning", side=1, line=1, at = 22.5, adj = 0.5)#
mtext("Elsewhere", side=1, line=1, at = 27.5, adj = 0.5)#
#
mtext("All venues", side=1, line=1, at = 32.5, adj = 0.5)#
mtext("Sexual Health", side=1, line=1, at = 37.5, adj = 0.5)#
mtext("GP", side=1, line=1, at = 42.5, adj = 0.5)#
mtext("Education", side=1, line=1, at = 47.5, adj = 0.5)#
mtext("Family Planning", side=1, line=1, at = 52.5, adj = 0.5)#
mtext("Elsewhere", side=1, line=1, at = 57.5, adj = 0.5)#
#
mtext("Women", side=1, line=3, at = 15, adj = 0.5)#
mtext("Men", side=1, line=3, at = 45, adj = 0.5)#
#
axis(side = 1, line = 2.5, at = c(1,29), labels = FALSE, tcl=0)#
axis(side = 1, line = 2.5, at = c(31,59), labels = FALSE, tcl=0)#
#
legend('topleft', inset = c(0.15,0.05),#
	col = 2:5,#
	pch = 1:4, lty = 1,#
	legend = c("All tested", "Reported NOT symptoms as reason for test", "Reported screening as reason for test", "Reported provider-initiated screening as reason for test")#
	)#
# lines for population prevalence#
lines(c(1, 29), 100*c(0.031, 0.031))#
lines(c(1, 29), 100*c(0.022, 0.022), lty=2)#
lines(c(1, 29), 100*c(0.043, 0.043), lty=2)#
#
lines(c(31, 59), 100*c(0.023, 0.023))#
lines(c(31, 59), 100*c(0.015, 0.015), lty=2)#
lines(c(31, 59), 100*c(0.034, 0.034), lty=2)
quartz(width=18, height=6)#
plot(dt$X, 100*dt$Estimate, col = dt$Subset, #
#pch = as.numeric(dt$Subset)-1,#
xaxt = 'n', ylim=c(0,25), xlab = "", ylab = "Percentage")
arrows(dt$X,#
	y0 = 100*dt$X2.5, y1 = 100*dt$X97.5,#
	col = dt$Subset,#
	code = 3, angle = 90, length = 0.05#
	)
mtext("All venues", side=1, line=1, at = 2.5, adj = 0.5)#
mtext("Sexual Health", side=1, line=1, at = 7.5, adj = 0.5)#
mtext("GP", side=1, line=1, at = 12.5, adj = 0.5)#
mtext("Education", side=1, line=1, at = 17.5, adj = 0.5)#
mtext("Family Planning", side=1, line=1, at = 22.5, adj = 0.5)#
mtext("Elsewhere", side=1, line=1, at = 27.5, adj = 0.5)#
#
mtext("All venues", side=1, line=1, at = 32.5, adj = 0.5)#
mtext("Sexual Health", side=1, line=1, at = 37.5, adj = 0.5)#
mtext("GP", side=1, line=1, at = 42.5, adj = 0.5)#
mtext("Education", side=1, line=1, at = 47.5, adj = 0.5)#
mtext("Family Planning", side=1, line=1, at = 52.5, adj = 0.5)#
mtext("Elsewhere", side=1, line=1, at = 57.5, adj = 0.5)#
#
mtext("Women", side=1, line=3, at = 15, adj = 0.5)#
mtext("Men", side=1, line=3, at = 45, adj = 0.5)
axis(side = 1, line = 2.5, at = c(1,29), labels = FALSE, tcl=0)#
axis(side = 1, line = 2.5, at = c(31,59), labels = FALSE, tcl=0)
legend('topleft', inset = c(0.15,0.05),#
	col = 2:5,#
	pch = 1:4, lty = 1,#
	legend = c("All tested", "Reported NOT symptoms as reason for test", "Reported screening as reason for test", "Reported provider-initiated screening as reason for test")#
	)
# lines for population prevalence#
lines(c(1, 29), 100*c(0.031, 0.031))#
lines(c(1, 29), 100*c(0.022, 0.022), lty=2)#
lines(c(1, 29), 100*c(0.043, 0.043), lty=2)#
#
lines(c(31, 59), 100*c(0.023, 0.023))#
lines(c(31, 59), 100*c(0.015, 0.015), lty=2)#
lines(c(31, 59), 100*c(0.034, 0.034), lty=2)
plot(dt$X, 100*dt$Estimate, col = dt$Subset, #
#pch = as.numeric(dt$Subset)-1,#
xaxt = 'n', ylim=c(0,25), xlab = "", ylab = "Percentage")#
#
arrows(dt$X,#
	y0 = 100*dt$X2.5, y1 = 100*dt$X97.5,#
	col = dt$Subset,#
	code = 3, angle = 90, length = 0.05#
	)#
mtext("All venues", side=1, line=1, at = 2.5, adj = 0.5)#
mtext("Sexual Health", side=1, line=1, at = 7.5, adj = 0.5)#
mtext("GP", side=1, line=1, at = 12.5, adj = 0.5)#
mtext("Education", side=1, line=1, at = 17.5, adj = 0.5)#
mtext("Family Planning", side=1, line=1, at = 22.5, adj = 0.5)#
mtext("Elsewhere", side=1, line=1, at = 27.5, adj = 0.5)#
#
mtext("All venues", side=1, line=1, at = 32.5, adj = 0.5)#
mtext("Sexual Health", side=1, line=1, at = 37.5, adj = 0.5)#
mtext("GP", side=1, line=1, at = 42.5, adj = 0.5)#
mtext("Education", side=1, line=1, at = 47.5, adj = 0.5)#
mtext("Family Planning", side=1, line=1, at = 52.5, adj = 0.5)#
mtext("Elsewhere", side=1, line=1, at = 57.5, adj = 0.5)#
#
mtext("Women", side=1, line=3, at = 15, adj = 0.5)#
mtext("Men", side=1, line=3, at = 45, adj = 0.5)#
#
axis(side = 1, line = 2.5, at = c(1,29), labels = FALSE, tcl=0)#
axis(side = 1, line = 2.5, at = c(31,59), labels = FALSE, tcl=0)#
#
legend('topleft', inset = c(0.15,0.05),#
	col = 2:5,#
#	pch = 1:4, #
	lty = 1,#
	legend = c("All tested", "Reported NOT symptoms as reason for test", "Reported screening as reason for test", "Reported provider-initiated screening as reason for test")#
	)#
# lines for population prevalence#
lines(c(1, 29), 100*c(0.031, 0.031))#
lines(c(1, 29), 100*c(0.022, 0.022), lty=2)#
lines(c(1, 29), 100*c(0.043, 0.043), lty=2)#
#
lines(c(31, 59), 100*c(0.023, 0.023))#
lines(c(31, 59), 100*c(0.015, 0.015), lty=2)#
lines(c(31, 59), 100*c(0.034, 0.034), lty=2)
plot(dt$X, 100*dt$Estimate, col = dt$Subset, #
#pch = as.numeric(dt$Subset)-1,#
xaxt = 'n', ylim=c(0,25), xlab = "", ylab = "Percentage")#
#
arrows(dt$X,#
	y0 = 100*dt$X2.5, y1 = 100*dt$X97.5,#
	col = dt$Subset,#
	code = 3, angle = 90, length = 0.05#
	)#
mtext("All venues", side=1, line=1, at = 2.5, adj = 0.5)#
mtext("Sexual Health", side=1, line=1, at = 7.5, adj = 0.5)#
mtext("GP", side=1, line=1, at = 12.5, adj = 0.5)#
mtext("Education", side=1, line=1, at = 17.5, adj = 0.5)#
mtext("Family Planning", side=1, line=1, at = 22.5, adj = 0.5)#
mtext("Elsewhere", side=1, line=1, at = 27.5, adj = 0.5)#
#
mtext("All venues", side=1, line=1, at = 32.5, adj = 0.5)#
mtext("Sexual Health", side=1, line=1, at = 37.5, adj = 0.5)#
mtext("GP", side=1, line=1, at = 42.5, adj = 0.5)#
mtext("Education", side=1, line=1, at = 47.5, adj = 0.5)#
mtext("Family Planning", side=1, line=1, at = 52.5, adj = 0.5)#
mtext("Elsewhere", side=1, line=1, at = 57.5, adj = 0.5)#
#
mtext("Women", side=1, line=3, at = 15, adj = 0.5)#
mtext("Men", side=1, line=3, at = 45, adj = 0.5)#
#
axis(side = 1, line = 2.5, at = c(1,29), labels = FALSE, tcl=0)#
axis(side = 1, line = 2.5, at = c(31,59), labels = FALSE, tcl=0)#
#
legend('topleft', inset = c(0.15,0.05),#
	col = 2:5,#
	pch = 1, #
	lty = 1,#
	legend = c("All tested", "Reported NOT symptoms as reason for test", "Reported screening as reason for test", "Reported provider-initiated screening as reason for test")#
	)#
# lines for population prevalence#
lines(c(1, 29), 100*c(0.031, 0.031))#
lines(c(1, 29), 100*c(0.022, 0.022), lty=2)#
lines(c(1, 29), 100*c(0.043, 0.043), lty=2)#
#
lines(c(31, 59), 100*c(0.023, 0.023))#
lines(c(31, 59), 100*c(0.015, 0.015), lty=2)#
lines(c(31, 59), 100*c(0.034, 0.034), lty=2)
svychisq(~(whnchlam == "Less than 1 year ago") + (why2 == "symptoms"))
svychisq(~(whnchlam == "Less than 1 year ago") + (why2 == "symptoms"),#
	design = subset(tdesign, rsex == "Male" & agrp == "16-24")#
	)
svychisq(~(whnchlam == "Less than 1 year ago") + (why2 == "symptoms"),#
	design = subset(tdesign, rsex == "Male")#
	)
svychisq(~(whnchlam == "Less than 1 year ago") + (why2 == "symptoms"),#
	design = tdesign, rsex == "Male"#
	)
# Analysis of Natsal data to compare positivity among non-symptomatic testers with population prevalence.#
#
rm(list=ls())#
#
library(foreign)#
library(survey)#
#
natsal3 <- read.dta("~/Documents/Natsal-3/UKDA-7799-stata11/stata11/eul_natsal_2010_for_archive.dta")#
#
#################################
# analysis on people who were tested for chlamydia#
#################################
#
# to be included in the subset tested for chlamydia in the last year, participants had to be:#
# sexually active (hetlife > 0 or samlife > 0)#
# aged < 45 (otherwise, were not asked whether they had tested)#
# EITHER diagnosed within the last year, OR reported testing within the last year#
tested <- natsal3[natsal3$hetlife >0 | natsal3$samlife > 0,]#
tested <- tested[tested$dage < 45,]#
tested <- tested[(tested$whnchlam == "Less than 1 year ago") | (tested$chlmtest == "Yes"),]#
#
##### restrict to 16-24-year-olds#
#tested <- tested[tested$agrp == "16-24",]#
#
tested$why <- factor(NA, levels = levels(tested$chtstwy1))#
tested$why[!(tested$chtstwy1 %in% c("Not applicable", "Not answered"))] <- tested$chtstwy1[!(tested$chtstwy1 %in% c("Not applicable", "Not answered"))]#
tested$why[!(tested$chltstwy %in% c("Not applicable", "Not answered"))] <- tested$chltstwy[!(tested$chltstwy %in% c("Not applicable", "Not answered"))]#
tested$why <- droplevels(tested$why)#
#
tested$why2 <- NA#
tested$why2[tested$why == "I had symptoms"] <- "symptoms"#
tested$why2[tested$why %in% c("My partner had symptoms", "I was notified because a partner was diagnosed with Chlamydia")] <- "partner"#
tested$why2[tested$why == "Check up after previous positive test"] <- "re-test"#
tested$why2[tested$why %in% c("I wanted a general sexual health check-up", "I had no symptoms but I was worried about the risk of Chlamydia", "I was offered a routine test")] <- "screen"#
tested$why2[tested$why == "Other"] <- "other"#
tested$why2 <- factor(tested$why2, levels = names(table(tested$why2))[order(table(tested$why2), decreasing=TRUE)], ordered = TRUE)#
#
tested$why3 <- as.character(tested$why2)#
tested$why3[tested$why %in% c("I wanted a general sexual health check-up", "I had no symptoms but I was worried about the risk of Chlamydia")] <- "screen - patient init"#
tested$why3[tested$why == "I was offered a routine test"] <- "screen - provider init"#
tested$why3 <- factor(tested$why3, levels = names(table(tested$why3))[order(table(tested$why3), decreasing=TRUE)], ordered = TRUE)#
#
tested$where <- factor(NA, levels = unique(c(levels(tested$chtstwh1), levels(tested$chltstwh))))#
tested$where[!(tested$chtstwh1 %in% c("Not applicable", "Not answered"))] <- tested$chtstwh1[!(tested$chtstwh1 %in% c("Not applicable", "Not answered"))]#
tested$where[!(tested$chltstwh %in% c("Not applicable", "Not answered"))] <- tested$chltstwh[!(tested$chltstwh %in% c("Not applicable", "Not answered"))]#
tested$where[tested$where == "NHS Family planning clinic / contraceptive clinic / reproductive health clinic"] <- "NHS FP clinic / contraceptive clinic / reproductive health clinic"#
tested$where <- droplevels(tested$where)#
#
tested$where2 <- NA#
tested$where2[tested$where == "Sexual health clinic (GUM clinic)"] <- "sexual health"#
tested$where2[tested$where == "General practice (GP) surgery"] <- "GP"#
tested$where2[tested$where == "NHS FP clinic / contraceptive clinic / reproductive health clinic"] <- "family planning"#
tested$where2[tested$where == "School / college / university"] <- "education"#
tested$where2[tested$where %in% c("Ante-natal Clinic / midwife", "Private non-NHS clinics or doctor", "Youth advisory clinic (e.g. Brook Clinic)", "Termination of pregnancy (abortion) clinic", "Hospital accident and emergency (A&E) department", "Pharmacy / chemist", "Internet", "Other non-health care place, e.g. youth club, festival, bar", "Somewhere else")] <- "elsewhere"#
#
tested$where2 <- factor(tested$where2, levels = names(table(tested$where2))[order(table(tested$where2), decreasing=TRUE)], ordered = TRUE)#
#
# set up survey design#
tdesign <- svydesign( #
		id = ~psu_scrm , #
		strata = ~stratagrp3 ,#
		data = tested ,		#
		weight = ~total_wt #
	)
svychisq(~(whnchlam == "Less than 1 year ago") + (why2 == "symptoms"),#
	design = tdesign, rsex == "Male"#
	)
svychisq(~(whnchlam == "Less than 1 year ago") + (why2 == "symptoms"),#
	design = tdesign#
	)
svytable(~(whnchlam == "Less than 1 year ago") + (why2 == "symptoms"),#
	design = tdesign#
	)
svychisq(~(whnchlam == "Less than 1 year ago") + (why2 == "symptoms"),#
	design = tdesign#
	)
svytable(~(whnchlam == "Less than 1 year ago") + (why2 == "symptoms"),#
	design = subset(tdesign, rsex == "Male")#
	)
svytable(~(whnchlam == "Less than 1 year ago") + (why2 == "symptoms"),#
	design = subset(tdesign, rsex == "Male" & agrp == "16-24")#
	)
svychisq(~(whnchlam == "Less than 1 year ago") + (why2 == "symptoms"),#
	design = subset(tdesign, rsex == "Male" & agrp == "16-24")#
	)
svychisq(~(tested$whnchlam == "Less than 1 year ago") + (tested$why2 == "symptoms"),#
	design = subset(tdesign, rsex == "Male" & agrp == "16-24")#
	)
svychisq(~(whnchlam == "Less than 1 year ago") + (why2 == "symptoms"),#
	design = subset(tdesign, rsex == "Male" & agrp == "16-24")#
	)
svychisq(~whnchlam + why2 ),#
	design = subset(tdesign, rsex == "Male" & agrp == "16-24")#
	)
svychisq(~whnchlam + why2 ,#
	design = subset(tdesign, rsex == "Male" & agrp == "16-24")#
	)
svytable(~(whnchlam == "Less than 1 year ago") + (why2 == "symptoms"),#
	design = subset(tdesign, rsex == "Male" & agrp == "16-24")#
	)
svychisq(~eval(whnchlam == "Less than 1 year ago") + eval(why2 == "symptoms"),#
	design = tdesign#
	)
td2 <- update(tdesign, diag = (whnchlam == "Less than 1 year ago"), symptoms = (why2 == "symptoms"))
svychisq(~diag + symptoms,#
	design = td2#
	)
td2 <- update(tdesign, diag = (whnchlam == "Less than 1 year ago"), symptoms = (why2 == "symptoms"))#
svychisq(~diag + symptoms,#
 	design = subset(td2, rsex == "Male")#
 	)
svychisq(~diag + symptoms,#
 	design = subset(td2, agrp == "16-24" & rsex == "Male")#
 	)
svychisq(~diag + symptoms,#
 	design = subset(td2, agrp == "16-24" & rsex == "Feale")#
 	)
svychisq(~diag + symptoms,#
 	design = subset(td2, agrp == "16-24" & rsex == "Female")#
 	)
td2 <- update(tdesign, diag = (whnchlam == "Less than 1 year ago"), symptoms = (why2 == "symptoms"), screen = (why2 =="screen"))
svychisq(~diag + screen,#
 	design = subset(td2, agrp == "16-24" & rsex == "Male")#
 	)
svychisq(~diag + screen,#
 	design = subset(td2, agrp == "16-24" & rsex == "Female")#
 	)
svychisq(~diag + screen,#
 	design = subset(td2, agrp == "16-24" & rsex == "Male" & !symptoms)#
 	)
svychisq(~diag + screen,#
 	design = subset(td2, agrp == "16-24" & rsex == "Female" & !symptoms)#
 	)
svychisq(~diag + why3,#
 	design = subset(td2, agrp == "16-24" & rsex == "Male" & screen)#
 	)
svychisq(~diag + why3,#
 	design = subset(td2, agrp == "16-24" & rsex == "Female" & screen)#
 	)
svytable(~diag + why3,#
 	design = subset(td2, agrp == "16-24" & rsex == "Male" & screen)#
 	)
td2 <- update(tdesign, diag = (whnchlam == "Less than 1 year ago"), symptoms = (why2 == "symptoms"), screen = (why2 =="screen"), provider_init = (why3 == "screen - provider init"))
svychisq(~diag + provider_init,#
 	design = subset(td2, agrp == "16-24" & rsex == "Male" & screen)#
 	)
svychisq(~diag + provider_init,#
 	design = subset(td2, agrp == "16-24" & rsex == "Female" & screen)#
 	)
###############################################
# plots (from csv file)#
###############################################
#
dt <- read.csv("~/Documents/ct_trends/Natsal_symptoms_testing/positivity_by_venue_reason_3.csv")#
#
quartz(width=18, height=6)#
plot(dt$X, 100*dt$Estimate, col = dt$Subset, #
#pch = as.numeric(dt$Subset)-1,#
xaxt = 'n', ylim=c(0,25), xlab = "", ylab = "Percentage")#
#
arrows(dt$X,#
	y0 = 100*dt$X2.5, y1 = 100*dt$X97.5,#
	col = dt$Subset,#
	code = 3, angle = 90, length = 0.05#
	)#
mtext("All venues", side=1, line=1, at = 2.5, adj = 0.5)#
mtext("Sexual Health", side=1, line=1, at = 7.5, adj = 0.5)#
mtext("GP", side=1, line=1, at = 12.5, adj = 0.5)#
mtext("Education", side=1, line=1, at = 17.5, adj = 0.5)#
mtext("Family Planning", side=1, line=1, at = 22.5, adj = 0.5)#
mtext("Elsewhere", side=1, line=1, at = 27.5, adj = 0.5)#
#
mtext("All venues", side=1, line=1, at = 32.5, adj = 0.5)#
mtext("Sexual Health", side=1, line=1, at = 37.5, adj = 0.5)#
mtext("GP", side=1, line=1, at = 42.5, adj = 0.5)#
mtext("Education", side=1, line=1, at = 47.5, adj = 0.5)#
mtext("Family Planning", side=1, line=1, at = 52.5, adj = 0.5)#
mtext("Elsewhere", side=1, line=1, at = 57.5, adj = 0.5)#
#
mtext("Men", side=1, line=3, at = 15, adj = 0.5)#
mtext("Women", side=1, line=3, at = 45, adj = 0.5)#
#
axis(side = 1, line = 2.5, at = c(1,29), labels = FALSE, tcl=0)#
axis(side = 1, line = 2.5, at = c(31,59), labels = FALSE, tcl=0)#
#
legend('topleft', inset = c(0.15,0.05),#
	col = 2:5,#
	pch = 1, #
	lty = 1,#
	legend = c("All tested", "Reported NOT symptoms as reason for test", "Reported screening as reason for test", "Reported provider-initiated screening as reason for test")#
	)#
# lines for population prevalence#
lines(c(1, 29), 100*c(0.031, 0.031))#
lines(c(1, 29), 100*c(0.022, 0.022), lty=2)#
lines(c(1, 29), 100*c(0.043, 0.043), lty=2)#
#
lines(c(31, 59), 100*c(0.023, 0.023))#
lines(c(31, 59), 100*c(0.015, 0.015), lty=2)#
lines(c(31, 59), 100*c(0.034, 0.034), lty=2)
for(j in unique(tested$where2)){#
	print(j)#
#
	svychisq(~diag + symptoms,#
	 	design = subset(td2, agrp == "16-24" & rsex == "Male" & where2 == j)#
	 	)#
	svychisq(~diag + symptoms,#
	 	design = subset(td2, agrp == "16-24" & rsex == "Female" & where2 == j)#
	 	)#
	svychisq(~diag + screen,#
	 	design = subset(td2, agrp == "16-24" & rsex == "Male" & !symptoms & where2 == j)#
	 	)#
	svychisq(~diag + screen,#
	 	design = subset(td2, agrp == "16-24" & rsex == "Female" & !symptoms & where2 == j)#
	 	)#
	svychisq(~diag + provider_init,#
	 	design = subset(td2, agrp == "16-24" & rsex == "Male" & screen & where2 == j)#
	 	)#
	svychisq(~diag + provider_init,#
	 	design = subset(td2, agrp == "16-24" & rsex == "Female" & screen & where2 == j)#
	 	)#
#
}
for(j in unique(tested$where2)){#
	print(j)#
	tdtemp <- update(td2, loc = (where2==j))#
#
	svychisq(~diag + symptoms,#
	 	design = subset(td2, agrp == "16-24" & rsex == "Male" & where2 == j)#
	 	)#
	svychisq(~diag + symptoms,#
	 	design = subset(td2, agrp == "16-24" & rsex == "Female" & where2 == j)#
	 	)#
	svychisq(~diag + screen,#
	 	design = subset(td2, agrp == "16-24" & rsex == "Male" & !symptoms & where2 == j)#
	 	)#
	svychisq(~diag + screen,#
	 	design = subset(td2, agrp == "16-24" & rsex == "Female" & !symptoms & where2 == j)#
	 	)#
	svychisq(~diag + provider_init,#
	 	design = subset(td2, agrp == "16-24" & rsex == "Male" & screen & where2 == j)#
	 	)#
	svychisq(~diag + provider_init,#
	 	design = subset(td2, agrp == "16-24" & rsex == "Female" & screen & where2 == j)#
	 	)#
#
}
j
j <- "GP"
print(j)
tdtemp <- update(td2, loc = (where2==j))
svychisq(~diag + symptoms,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & where2 == j)#
	 	)
for(j in unique(tested$where2)){#
	print(j)#
	tdtemp <- update(td2, loc = (where2==j))#
#
	svychisq(~diag + symptoms,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & where2 == j)#
	 	)#
	svychisq(~diag + symptoms,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & where2 == j)#
	 	)#
	svychisq(~diag + screen,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & !symptoms & where2 == j)#
	 	)#
	svychisq(~diag + screen,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & !symptoms & where2 == j)#
	 	)#
	svychisq(~diag + provider_init,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & screen & where2 == j)#
	 	)#
	svychisq(~diag + provider_init,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & screen & where2 == j)#
	 	)#
#
}
j
j <- "GP"
for(j in unique(tested$where2)){#
	print(j)#
	tdtemp <- update(td2, loc = (where2==j))#
#
	print(svychisq(~diag + symptoms,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & where2 == j)#
	 	))#
	svychisq(~diag + symptoms,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & where2 == j)#
	 	)#
	svychisq(~diag + screen,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & !symptoms & where2 == j)#
	 	)#
	svychisq(~diag + screen,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & !symptoms & where2 == j)#
	 	)#
	svychisq(~diag + provider_init,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & screen & where2 == j)#
	 	)#
	svychisq(~diag + provider_init,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & screen & where2 == j)#
	 	)#
#
}
for(j in unique(tested$where2)){#
	print(j)#
	tdtemp <- update(td2, loc = (where2==j))#
#
	print(svychisq(~diag + symptoms,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & where2 == j)#
	 	))#
	print(svychisq(~diag + symptoms,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & where2 == j)#
	 	))#
	print(svychisq(~diag + screen,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & !symptoms & where2 == j)#
	 	))#
	print(svychisq(~diag + screen,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & !symptoms & where2 == j)#
	 	))#
	print(svychisq(~diag + provider_init,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & screen & where2 == j)#
	 	))#
	print(svychisq(~diag + provider_init,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & screen & where2 == j)#
	 	))#
#
}
j
tdtemp <- update(td2, loc = (where2==j))
svytable(~diag + symptoms,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & where2 == j)#
	 	)
svytable(~diag + symptoms,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & where2 == j),#
	 	na.rm=FALSE)
for(j in unique(tested$where2)){#
	print(j)#
	tdtemp <- update(td2, loc = (where2==j))#
#
	try(print(svychisq(~diag + symptoms,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & where2 == j)#
	 	)))#
	try(print(svychisq(~diag + symptoms,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & where2 == j)#
	 	)))#
	try(print(svychisq(~diag + screen,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & !symptoms & where2 == j)#
	 	)))#
	try(print(svychisq(~diag + screen,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & !symptoms & where2 == j)#
	 	)))#
	try(print(svychisq(~diag + provider_init,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & screen & where2 == j)#
	 	)))#
	try(print(svychisq(~diag + provider_init,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & screen & where2 == j)#
	 	)))#
#
}
for(j in unique(tested$where2)){#
	print(j)#
	tdtemp <- update(td2, loc = (where2==j))#
#
	svytable(~diag + symptoms,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & where2 == j)#
	 	)#
	try(print(svychisq(~diag + symptoms,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & where2 == j)#
	 	)))#
	svytable(~diag + symptoms,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & where2 == j)#
	 	))#
	try(print(svychisq(~diag + symptoms,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & where2 == j)#
	 	)))#
	svytable(~diag + screen,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & !symptoms & where2 == j)#
	 	)#
	try(print(svychisq(~diag + screen,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & !symptoms & where2 == j)#
	 	)))#
	svytable(~diag + screen,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & !symptoms & where2 == j)#
	 	)#
	try(print(svychisq(~diag + screen,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & !symptoms & where2 == j)#
	 	)))#
	svytable(~diag + provider_init,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & screen & where2 == j)#
	 	)#
	try(print(svychisq(~diag + provider_init,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & screen & where2 == j)#
	 	)))#
	svytable(~diag + provider_init,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & screen & where2 == j)#
	 	)#
	try(print(svychisq(~diag + provider_init,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & screen & where2 == j)#
	 	)))#
#
}
for(j in unique(tested$where2)){#
	print(j)#
	tdtemp <- update(td2, loc = (where2==j))#
#
	svytable(~diag + symptoms,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & where2 == j)#
	 	)#
	try(print(svychisq(~diag + symptoms,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & where2 == j)#
	 	)))#
	svytable(~diag + symptoms,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & where2 == j)#
	 	)#
	try(print(svychisq(~diag + symptoms,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & where2 == j)#
	 	)))#
	svytable(~diag + screen,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & !symptoms & where2 == j)#
	 	)#
	try(print(svychisq(~diag + screen,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & !symptoms & where2 == j)#
	 	)))#
	svytable(~diag + screen,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & !symptoms & where2 == j)#
	 	)#
	try(print(svychisq(~diag + screen,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & !symptoms & where2 == j)#
	 	)))#
	svytable(~diag + provider_init,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & screen & where2 == j)#
	 	)#
	try(print(svychisq(~diag + provider_init,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & screen & where2 == j)#
	 	)))#
	svytable(~diag + provider_init,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & screen & where2 == j)#
	 	)#
	try(print(svychisq(~diag + provider_init,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & screen & where2 == j)#
	 	)))#
#
}
for(j in unique(tested$where2)){#
	print(j)#
	tdtemp <- update(td2, loc = (where2==j))#
#
	print(svytable(~diag + symptoms,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & where2 == j)#
	 	))#
	try(print(svychisq(~diag + symptoms,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & where2 == j)#
	 	)))#
	svytable(~diag + symptoms,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & where2 == j)#
	 	)#
	try(print(svychisq(~diag + symptoms,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & where2 == j)#
	 	)))#
	svytable(~diag + screen,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & !symptoms & where2 == j)#
	 	)#
	try(print(svychisq(~diag + screen,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & !symptoms & where2 == j)#
	 	)))#
	svytable(~diag + screen,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & !symptoms & where2 == j)#
	 	)#
	try(print(svychisq(~diag + screen,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & !symptoms & where2 == j)#
	 	)))#
	svytable(~diag + provider_init,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & screen & where2 == j)#
	 	)#
	try(print(svychisq(~diag + provider_init,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & screen & where2 == j)#
	 	)))#
	svytable(~diag + provider_init,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & screen & where2 == j)#
	 	)#
	try(print(svychisq(~diag + provider_init,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & screen & where2 == j)#
	 	)))#
#
}
for(j in unique(tested$where2)){#
	print(j)#
	tdtemp <- update(td2, loc = (where2==j))#
#
	print(svytable(~diag + symptoms,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & where2 == j)#
	 	))#
	try(print(svychisq(~diag + symptoms,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & where2 == j)#
	 	)))#
	print(svytable(~diag + symptoms,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & where2 == j)#
	 	))#
	try(print(svychisq(~diag + symptoms,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & where2 == j)#
	 	)))#
	print(svytable(~diag + screen,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & !symptoms & where2 == j)#
	 	))#
	try(print(svychisq(~diag + screen,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & !symptoms & where2 == j)#
	 	)))#
	print(svytable(~diag + screen,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & !symptoms & where2 == j)#
	 	))#
	try(print(svychisq(~diag + screen,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & !symptoms & where2 == j)#
	 	)))#
	print(svytable(~diag + provider_init,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & screen & where2 == j)#
	 	))#
	try(print(svychisq(~diag + provider_init,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Male" & screen & where2 == j)#
	 	)))#
	print(svytable(~diag + provider_init,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & screen & where2 == j)#
	 	))#
	try(print(svychisq(~diag + provider_init,#
	 	design = subset(tdtemp, agrp == "16-24" & rsex == "Female" & screen & where2 == j)#
	 	)))#
#
}
rm(list=ls())
ls()
source("/Users/Joanna/Documents/M_Genitalium/data/Cohen/read_cohen.R")
head(allfup)
kormain <- read.sas7bdat('~/Documents/M_Genitalium/data/Cohen/kormain.sas7bdat')
head(kormain)
nrow(kormain)
names(allfup)
sort(names(allfup))
drat:::add("mrc-ide")
install.packages(c("odin", "dde"))
dt <- read.csv("~/Documents/ct_trends/Natsal_symptoms_testing/positivity_by_nonocong_1.csv")#
#
quartz(width=18, height=6)#
plot(dt$X, 100*dt$Estimate, col = dt$Subset, #
	#pch = as.numeric(dt$Subset)-1,#
	xaxt = 'n', ylim=c(0,25), xlab = "", ylab = "Percentage")#
#
arrows(dt$X,#
	y0 = 100*dt$X2.5, y1 = 100*dt$X97.5,#
	col = dt$Subset,#
	code = 3, angle = 90, length = 0.05#
	)#
mtext("0", side=1, line=1, at = 2.5, adj = 0.5)#
mtext("1", side=1, line=1, at = 7.5, adj = 0.5)#
mtext("2+", side=1, line=1, at = 12.5, adj = 0.5)#
#
mtext("0", side=1, line=1, at = 17.5, adj = 0.5)#
mtext("1", side=1, line=1, at = 22.5, adj = 0.5)#
mtext("2+", side=1, line=1, at = 27.5, adj = 0.5)#
#
mtext("Men", side=1, line=3, at = 7.5, adj = 0.5)#
mtext("Women", side=1, line=3, at = 22.5, adj = 0.5)#
#
axis(side = 1, line = 2.5, at = c(1,14), labels = FALSE, tcl=0)#
axis(side = 1, line = 2.5, at = c(16,29), labels = FALSE, tcl=0)#
#
legend('topleft', inset = c(0.01,0.05),#
	col = 2:5,#
	pch = 1, #
	lty = 1,#
	legend = c("All tested", "Reported NOT symptoms as reason for test", "Reported screening as reason for test", "Reported provider-initiated screening as reason for test")#
	)#
# lines for population prevalence#
lines(c(1, 14), 100*c(0.031, 0.031))#
lines(c(1, 14), 100*c(0.022, 0.022), lty=2)#
lines(c(1, 14), 100*c(0.043, 0.043), lty=2)#
#
lines(c(16, 29), 100*c(0.023, 0.023))#
lines(c(16, 29), 100*c(0.015, 0.015), lty=2)#
lines(c(16, 29), 100*c(0.034, 0.034), lty=2)
lines(c(1, 4),c(0.3, 0.3))
polygon(c(1,4,4,1), c(0.1,0.1,1.3,1.3), col=rgb(0,0,0,0.01), border=NA)
polygon(c(1,4,4,1), c(0.1,0.1,1.3,1.3), col=rgb(0,0,0,0.1), border=NA)
lines(c(6, 9), c(1.7, 1.7))
polygon(c(6,9,9,6), c(0.8,0.8,3.6,3.6), col=rgb(0,0,0,0.01), border=NA)
polygon(c(6,9,9,6), c(0.8,0.8,3.6,3.6), col=rgb(0,0,0,0.1), border=NA)
lines(c(11, 14),c(6.5, 6.5))
polygon(c(11,14,14,11), c(3.9,3.9,10.9,10.9), col=rgb(0,0,0,0.01), border=NA)
polygon(c(11,14,14,11), c(3.9,3.9,10.9,10.9), col=rgb(0,0,0,0.1), border=NA)
lines(c(16, 19),c(2.9, 2.9))#
polygon(c(16,19,19,16), c(1.2,1.2,7.1,7.1), col=rgb(0,0,0,0.1), border=NA)#
#
lines(c(20, 23), c(2.2, 2.2))#
polygon(c(20,23,23,20), c(1.4,1.4,3.6,3.6), col=rgb(0,0,0,0.1), border=NA)#
#
lines(c(25, 28),c(6.3, 6.3))#
polygon(c(25,28,28,25), c(3.5,3.5,11.2,11.2), col=rgb(0,0,0,0.1), border=NA)
quartz(width=18, height=6)#
plot(dt$X, 100*dt$Estimate, col = dt$Subset, #
	#pch = as.numeric(dt$Subset)-1,#
	xaxt = 'n', ylim=c(0,25), xlab = "", ylab = "Percentage")#
#
arrows(dt$X,#
	y0 = 100*dt$X2.5, y1 = 100*dt$X97.5,#
	col = dt$Subset,#
	code = 3, angle = 90, length = 0.05#
	)#
mtext("0", side=1, line=1, at = 2.5, adj = 0.5)#
mtext("1", side=1, line=1, at = 7.5, adj = 0.5)#
mtext("2+", side=1, line=1, at = 12.5, adj = 0.5)#
#
mtext("0", side=1, line=1, at = 17.5, adj = 0.5)#
mtext("1", side=1, line=1, at = 22.5, adj = 0.5)#
mtext("2+", side=1, line=1, at = 27.5, adj = 0.5)#
#
mtext("Men", side=1, line=3, at = 7.5, adj = 0.5)#
mtext("Women", side=1, line=3, at = 22.5, adj = 0.5)#
#
axis(side = 1, line = 2.5, at = c(1,14), labels = FALSE, tcl=0)#
axis(side = 1, line = 2.5, at = c(16,29), labels = FALSE, tcl=0)#
#
legend('topleft', inset = c(0.01,0.05),#
	col = 2:5,#
	pch = 1, #
	lty = 1,#
	legend = c("All tested", "Reported NOT symptoms as reason for test", "Reported screening as reason for test", "Reported provider-initiated screening as reason for test")#
	)#
# lines for population prevalence#
lines(c(1, 14), 100*c(0.031, 0.031))#
lines(c(1, 14), 100*c(0.022, 0.022), lty=2)#
lines(c(1, 14), 100*c(0.043, 0.043), lty=2)#
#
lines(c(16, 29), 100*c(0.023, 0.023))#
lines(c(16, 29), 100*c(0.015, 0.015), lty=2)#
lines(c(16, 29), 100*c(0.034, 0.034), lty=2)#
#
# shading for population prevalence by group#
lines(c(1, 4),c(0.3, 0.3))#
polygon(c(1,4,4,1), c(0.1,0.1,1.3,1.3), col=rgb(0,0,0,0.1), border=NA)#
#
lines(c(6, 9), c(1.7, 1.7))#
polygon(c(6,9,9,6), c(0.8,0.8,3.6,3.6), col=rgb(0,0,0,0.1), border=NA)#
#
lines(c(11, 14),c(6.5, 6.5))#
polygon(c(11,14,14,11), c(3.9,3.9,10.9,10.9), col=rgb(0,0,0,0.1), border=NA)#
#
lines(c(16, 19),c(2.9, 2.9))#
polygon(c(16,19,19,16), c(1.2,1.2,7.1,7.1), col=rgb(0,0,0,0.1), border=NA)#
#
lines(c(21, 23), c(2.2, 2.2))#
polygon(c(21,24,24,21), c(1.4,1.4,3.6,3.6), col=rgb(0,0,0,0.1), border=NA)#
#
lines(c(26, 29),c(6.3, 6.3))#
polygon(c(26,29,29,26), c(3.5,3.5,11.2,11.2), col=rgb(0,0,0,0.1), border=NA)
quatrz()
quartz()
plot(seq(0,1,0.01), -log(1-seq(0,1,0.01)), type='l')
plot(seq(0,1,0.01), -log(1-seq(0,1,0.01)), type='l', xlim=c(0,0.7))
plot(seq(0,1,0.01), -log(1-seq(0,1,0.01)), type='l', xlim=c(0,0.7), ylim=c(0,1))
plot(seq(0,1,0.01), -log(1-seq(0,1,0.01)), type='l', xlim=c(0,0.7), ylim=c(0,1.5))
abline(0,1)
shiny::runApp(system.file("examples/sis_app.R", package = "odin.ui", mustWork = TRUE))
install.packages("httpuv")
shiny::runApp(system.file("examples/sis_app.R", package = "odin.ui", mustWork = TRUE))
install.packages(c("odin", "dde"))
drat:::add("mrc-ide")#
install.packages(c("odin", "dde"))
shiny::runApp(system.file("examples/sis_app.R", package = "odin.ui", mustWork = TRUE))
devtools::install_github("mrc-ide/odin@i137_restrict_user", upgrade = FALSE)
shiny::runApp(system.file("examples/sis_app.R", package = "odin.ui", mustWork = TRUE))
plot(1:14, exp(0.5*(1:14)))
# Analysis of Natsal data to compare positivity among non-symptomatic testers with population prevalence.#
#
rm(list=ls())#
#
library(foreign)#
library(survey)#
#
natsal3 <- read.dta("~/Documents/Natsal-3/UKDA-7799-stata11/stata11/eul_natsal_2010_for_archive.dta")
#################################
# analysis on people who were tested for chlamydia#
#################################
#
# to be included in the subset tested for chlamydia in the last year, participants had to be:#
# sexually active (hetlife > 0 or samlife > 0)#
# aged < 45 (otherwise, were not asked whether they had tested)#
# EITHER diagnosed within the last year, OR reported testing within the last year#
#
tested <- natsal3[ (natsal3$whnchlam == "Less than 1 year ago") | (natsal3$chlmtest == "Yes"), ]#
tested <- tested[ tested$chlmtest != "No", ]#
tested <- tested[ !(tested$totlife %in% c(0,9999)), ]#
#
##### restrict to 16-24-year-olds#
#tested <- tested[tested$agrp == "16-24",]#
#
tested$why <- factor(NA, levels = levels(tested$chtstwy1))#
tested$why[!(tested$chtstwy1 %in% c("Not applicable", "Not answered"))] <- tested$chtstwy1[!(tested$chtstwy1 %in% c("Not applicable", "Not answered"))]#
tested$why[!(tested$chltstwy %in% c("Not applicable", "Not answered"))] <- tested$chltstwy[!(tested$chltstwy %in% c("Not applicable", "Not answered"))]#
tested$why <- droplevels(tested$why)#
#
tested$why2 <- NA#
tested$why2[tested$why == "I had symptoms"] <- "symptoms"#
tested$why2[tested$why %in% c("My partner had symptoms", "I was notified because a partner was diagnosed with Chlamydia")] <- "partner"#
tested$why2[tested$why == "Check up after previous positive test"] <- "re-test"#
tested$why2[tested$why %in% c("I wanted a general sexual health check-up", "I had no symptoms but I was worried about the risk of Chlamydia", "I was offered a routine test")] <- "screen"#
tested$why2[tested$why == "Other"] <- "other"#
tested$why2 <- factor(tested$why2, levels = names(table(tested$why2))[order(table(tested$why2), decreasing=TRUE)], ordered = TRUE)#
#
tested$why3 <- as.character(tested$why2)#
tested$why3[tested$why %in% c("I wanted a general sexual health check-up", "I had no symptoms but I was worried about the risk of Chlamydia")] <- "screen - patient init"#
tested$why3[tested$why == "I was offered a routine test"] <- "screen - provider init"#
tested$why3 <- factor(tested$why3, levels = names(table(tested$why3))[order(table(tested$why3), decreasing=TRUE)], ordered = TRUE)#
#
tested$imd_grouped <- factor(tested$adj_imd_quintile, levels=1:5, labels=c("1-2","1-2","3","4-5","4-5"))#
#
# set up survey design#
tdesign <- svydesign( #
		id = ~psu_scrm , #
		strata = ~stratagrp3 ,#
		data = tested ,		#
		weight = ~total_wt #
	)
###################################################
# positivity, by partners without a condom, last year#
###################################################
#
for(i in unique(tested$rsex)){#
	print(i)#
	for(k in unique(tested$nonocong)){#
		print(k)#
		try(print(svyciprop(~(whnchlam == "Less than 1 year ago"),#
			design = subset(tdesign, rsex == i & agrp == "16-24" & nonocong == k)#
			)))#
		try(print(svyciprop(~(whnchlam == "Less than 1 year ago"),#
			design = subset(tdesign, rsex == i & agrp == "16-24" & nonocong == k & why2 != "symptoms")#
			)))#
#
		try(print(svyciprop(~(whnchlam == "Less than 1 year ago"),#
			design = subset(tdesign, rsex == i & agrp == "16-24" & nonocong == k & why2 == "screen")#
			)))#
#
		try(print(svyciprop(~(whnchlam == "Less than 1 year ago"),#
			design = subset(tdesign, rsex == i & agrp == "16-24" & nonocong == k & why3 == "screen - provider init")#
			)))#
	}#
}
dt <- read.csv("~/Documents/ct_trends/Natsal_symptoms_testing/positivity_by_nonocong_1.csv")#
#
quartz(width=18, height=6)#
plot(dt$X, 100*dt$Estimate, col = dt$Subset, #
	#pch = as.numeric(dt$Subset)-1,#
	xaxt = 'n', ylim=c(0,25), xlab = "", ylab = "Percentage")#
#
arrows(dt$X,#
	y0 = 100*dt$X2.5, y1 = 100*dt$X97.5,#
	col = dt$Subset,#
	code = 3, angle = 90, length = 0.05#
	)#
mtext("0", side=1, line=1, at = 2.5, adj = 0.5)#
mtext("1", side=1, line=1, at = 7.5, adj = 0.5)#
mtext("2+", side=1, line=1, at = 12.5, adj = 0.5)#
#
mtext("0", side=1, line=1, at = 17.5, adj = 0.5)#
mtext("1", side=1, line=1, at = 22.5, adj = 0.5)#
mtext("2+", side=1, line=1, at = 27.5, adj = 0.5)#
#
mtext("Men", side=1, line=3, at = 7.5, adj = 0.5)#
mtext("Women", side=1, line=3, at = 22.5, adj = 0.5)#
#
axis(side = 1, line = 2.5, at = c(1,14), labels = FALSE, tcl=0)#
axis(side = 1, line = 2.5, at = c(16,29), labels = FALSE, tcl=0)#
#
legend('topleft', inset = c(0.01,0.05),#
	col = 2:5,#
	pch = 1, #
	lty = 1,#
	legend = c("All tested", "Reported NOT symptoms as reason for test", "Reported screening as reason for test", "Reported provider-initiated screening as reason for test")#
	)#
# lines for population prevalence#
lines(c(1, 14), 100*c(0.031, 0.031))#
lines(c(1, 14), 100*c(0.022, 0.022), lty=2)#
lines(c(1, 14), 100*c(0.043, 0.043), lty=2)#
#
lines(c(16, 29), 100*c(0.023, 0.023))#
lines(c(16, 29), 100*c(0.015, 0.015), lty=2)#
lines(c(16, 29), 100*c(0.034, 0.034), lty=2)#
#
# shading for population prevalence by group#
lines(c(1, 4),c(0.3, 0.3))#
polygon(c(1,4,4,1), c(0.1,0.1,1.3,1.3), col=rgb(0,0,0,0.1), border=NA)#
#
lines(c(6, 9), c(1.7, 1.7))#
polygon(c(6,9,9,6), c(0.8,0.8,3.6,3.6), col=rgb(0,0,0,0.1), border=NA)#
#
lines(c(11, 14),c(6.5, 6.5))#
polygon(c(11,14,14,11), c(3.9,3.9,10.9,10.9), col=rgb(0,0,0,0.1), border=NA)#
#
lines(c(16, 19),c(2.9, 2.9))#
polygon(c(16,19,19,16), c(1.2,1.2,7.1,7.1), col=rgb(0,0,0,0.1), border=NA)#
#
lines(c(21, 23), c(2.2, 2.2))#
polygon(c(21,24,24,21), c(1.4,1.4,3.6,3.6), col=rgb(0,0,0,0.1), border=NA)#
#
lines(c(26, 29),c(6.3, 6.3))#
polygon(c(26,29,29,26), c(3.5,3.5,11.2,11.2), col=rgb(0,0,0,0.1), border=NA)
1784/15
7*1.78*1784/15
379/50
33*4.09*379/50
1481.91+1023.07
340*12
4080-200
# Analysis of Natsal data to investigate correlations between reason for test and test setting
rm(list=ls())
library(foreign)
library(survey)
library(vcd)
options(survey.lonely.psu="adjust")
natsal3 <- read.dta("/Users/Joanna/OneDrive - Imperial College London/backup/Natsal-3/UKDA-7799-stata11/stata11/eul_natsal_2010_for_archive.dta")
# Analysis of Natsal data to investigate correlations between reason for test and test setting#
#
rm(list=ls())#
#
library(foreign)#
library(survey)#
library(vcd)#
#
options(survey.lonely.psu="adjust")#
#
natsal3 <- read.dta("/Users/Joanna/OneDrive - Imperial College London/backup/Natsal-3/UKDA-7799-stata11/stata11/eul_natsal_2010_for_archive.dta")
#################################
# analysis on people who were tested for chlamydia#
#################################
#
# to be included in the subset tested for chlamydia in the last year, participants had to be:#
# sexually active (hetlife > 0 or samlife > 0)#
# aged < 45 (otherwise, were not asked whether they had tested)#
# EITHER diagnosed within the last year, OR reported testing within the last year#
#
tested <- natsal3[ (natsal3$whnchlam == "Less than 1 year ago") | (natsal3$chlmtest == "Yes"), ]#
tested <- tested[ tested$chlmtest != "No", ]#
tested <- tested[ !(tested$totlife %in% c(0,9999)), ]#
#
##### restrict to 16-24-year-olds#
tested <- tested[tested$agrp == "16-24",]#
#
##### reason recorded for chlamydia testing#
tested$why <- factor(NA, levels = levels(tested$chtstwy1))#
tested$why[!(tested$chtstwy1 %in% c("Not applicable", "Not answered"))] <- tested$chtstwy1[!(tested$chtstwy1 %in% c("Not applicable", "Not answered"))]#
tested$why[!(tested$chltstwy %in% c("Not applicable", "Not answered"))] <- tested$chltstwy[!(tested$chltstwy %in% c("Not applicable", "Not answered"))]#
tested$why <- droplevels(tested$why)#
#
##### amalgamate two categories into "partner", and three into "screen"#
tested$why2 <- NA#
tested$why2[tested$why == "I had symptoms"] <- "symptoms"#
tested$why2[tested$why %in% c("My partner had symptoms", "I was notified because a partner was diagnosed with Chlamydia")] <- "partner"#
tested$why2[tested$why == "Check up after previous positive test"] <- "re-test"#
tested$why2[tested$why %in% c("I wanted a general sexual health check-up", "I had no symptoms but I was worried about the risk of Chlamydia", "I was offered a routine test")] <- "screen"#
tested$why2[tested$why == "Other"] <- "other"#
tested$why2 <- factor(tested$why2, levels = names(table(tested$why2))[order(table(tested$why2), decreasing=TRUE)], ordered = TRUE)#
#
##### distinguish between patient-initiated and provider-initiated screens#
tested$why3 <- as.character(tested$why2)#
tested$why3[tested$why %in% c("I wanted a general sexual health check-up", "I had no symptoms but I was worried about the risk of Chlamydia")] <- "screen - patient init"#
tested$why3[tested$why == "I was offered a routine test"] <- "screen - provider init"#
tested$why3 <- factor(tested$why3, levels = names(table(tested$why3))[order(table(tested$why3), decreasing=TRUE)], ordered = TRUE)#
#
##### symptoms/screen/other#
tested$why4 <- as.character(tested$why2)#
tested$why4[tested$why2 %in% c("partner", "re-test", "other")] <- "other"#
tested$why4 <- factor(tested$why4, levels = c("other", "symptoms", "screen"), ordered = TRUE)#
#
##### symptoms/screen/other#
tested$why5 <- as.character(tested$why2)#
tested$why5[tested$why2 %in% c("partner", "re-test", "other")] <- "screen"#
tested$why5 <- factor(tested$why5, levels = c("symptoms", "screen"), ordered = TRUE)#
##### where were tests carried out?#
tested$where <- factor(NA, levels = unique(c(levels(tested$chtstwh1), levels(tested$chltstwh))))#
tested$where[!(tested$chtstwh1 %in% c("Not applicable", "Not answered"))] <- tested$chtstwh1[!(tested$chtstwh1 %in% c("Not applicable", "Not answered"))]#
tested$where[!(tested$chltstwh %in% c("Not applicable", "Not answered"))] <- tested$chltstwh[!(tested$chltstwh %in% c("Not applicable", "Not answered"))]#
tested$where[tested$where == "NHS Family planning clinic / contraceptive clinic / reproductive health clinic"] <- "NHS FP clinic / contraceptive clinic / reproductive health clinic"#
tested$where <- droplevels(tested$where)#
#
##### combine categories#
tested$where2 <- NA#
tested$where2[tested$where == "Sexual health clinic (GUM clinic)"] <- "sexual health"#
tested$where2[tested$where == "General practice (GP) surgery"] <- "GP"#
tested$where2[tested$where == "NHS FP clinic / contraceptive clinic / reproductive health clinic"] <- "family planning"#
tested$where2[tested$where == "School / college / university"] <- "education"#
tested$where2[tested$where %in% c("Ante-natal Clinic / midwife", "Private non-NHS clinics or doctor", "Youth advisory clinic (e.g. Brook Clinic)", "Termination of pregnancy (abortion) clinic", "Hospital accident and emergency (A&E) department", "Pharmacy / chemist", "Internet", "Other non-health care place, e.g. youth club, festival, bar", "Somewhere else")] <- "elsewhere"#
#
tested$where2 <- factor(tested$where2, levels = names(table(tested$where2))[order(table(tested$where2), decreasing=TRUE)], ordered = TRUE)#
#
##### only three categories#
tested$where3 <- tested$where2#
tested$where3[tested$where2 %in% c("family planning", "education", "elsewhere")] <- "elsewhere"#
tested$where3 <- factor(tested$where3, levels = c("sexual health", "GP", "elsewhere"), ordered = TRUE)#
##### group deprivation quintiles#
tested$imd_grouped <- factor(tested$adj_imd_quintile, levels=1:5, labels=c("1-2","1-2","3","4-5","4-5"))#
#
tested$nncg <- tested$nonocong#
tested$nncg[!(tested$nncg %in% c("No unprotected vaginal/anal het. sex in last year", "1 partner", "2+ partners"))] <- NA#
tested$nncg <- droplevels(tested$nncg)#
#
tested$tny3 <- tested$totnewy3#
tested$tny3[!(tested$tny3 %in% c("0 new het.&/or sam. partners in last year", "1 new het.&/or sam. partner in last year", "2+ new het.&/or sam. partners in last year"))] <- NA#
tested$tny3 <- droplevels(tested$tny3)#
#
# set up survey design#
tdesign <- svydesign( #
		id = ~psu_scrm , #
		strata = ~stratagrp3 ,#
		data = tested ,		#
		weight = ~total_wt #
	)
###################
# mosaic plots#
###################
#
cols <- c(rgb(135,93,167, maxColorValue = 256), rgb(168,91,74, maxColorValue = 256), rgb(143,183,113, maxColorValue = 256))#
#
venue_reason_table_m <- svytable(~ where3 + why4 , design=subset(tdesign, rsex == "Male"), Ntotal = 1 )#
venue_reason_table_f <- svytable(~ where3 + why4 , design=subset(tdesign, rsex == "Female"), Ntotal = 1  )#
#
quartz(width=11, height=7)#
layout(matrix(1:3, nrow=1, byrow=TRUE), widths=c(5,1,5), heights=7)#
par(oma=c(0,0,0,0), mar=c(5, 0, 5, 0))#
#par(omi = c(0,0,0,0))#, mai=c(1,0,1,0), las=1)
mosaicplot(venue_reason_table_m, color=cols, xlab="", ylab="", main= "", las=1, cex.axis=0.001)#
mtext('Men', side=3, line=2, cex=2, font=2)#
axis(side=1, tick=FALSE, cex.axis=1.5,#
	at=cumsum(apply(venue_reason_table_m, 1, sum)) - 0.5*apply(venue_reason_table_m, 1, sum),#
	labels = c('sexual health', 'GP', 'elsewhere'),#
	)#
yl <- par("usr")[3:4]
plot(0,0,pch="", xlim=c(-0.1,0.1), ylim=yl, xlab="", ylab="", bty="n", axes=FALSE)#
text(c(0,0,0), #
	1 - (cumsum(apply(venue_reason_table_f, 2, sum)) - 0.5*apply(venue_reason_table_f, 2, sum)), #
	c("other", "symptoms", "screen"),#
	cex=1.5)#
#
mosaicplot(venue_reason_table_f, color=cols, xlab="", ylab="", main= "", las=1, cex.axis=0.001)#
mtext('Women', side=3, line=2, cex=2, font=2)#
axis(side=1, tick=FALSE, cex.axis=1.5,#
	at=cumsum(apply(venue_reason_table_f, 1, sum)) - 0.5*apply(venue_reason_table_f, 1, sum),#
	labels = c('sexual health', 'GP', 'elsewhere'),#
	)
mtext('Men', side=3, line=1.5, cex=1.5, font=2)
quartz(width=11, height=7)#
layout(matrix(1:3, nrow=1, byrow=TRUE), widths=c(5,1,5), heights=7)#
par(oma=c(0,0,0,0), mar=c(5, 0, 5, 0))#
#par(omi = c(0,0,0,0))#, mai=c(1,0,1,0), las=1)#
#
mosaicplot(venue_reason_table_m, color=cols, xlab="", ylab="", main= "", las=1, cex.axis=0.001)#
mtext('Men', side=3, line=1, cex=1.5, font=2)#
axis(side=1, tick=FALSE, cex.axis=1.5,#
	at=cumsum(apply(venue_reason_table_m, 1, sum)) - 0.5*apply(venue_reason_table_m, 1, sum),#
	labels = c('sexual health', 'GP', 'elsewhere'),#
	)#
yl <- par("usr")[3:4]#
#
plot(0,0,pch="", xlim=c(-0.1,0.1), ylim=yl, xlab="", ylab="", bty="n", axes=FALSE)#
text(c(0,0,0), #
	1 - (cumsum(apply(venue_reason_table_f, 2, sum)) - 0.5*apply(venue_reason_table_f, 2, sum)), #
	c("other", "symptoms", "screen"),#
	cex=1.5)#
#
mosaicplot(venue_reason_table_f, color=cols, xlab="", ylab="", main= "", las=1, cex.axis=0.001)#
mtext('Women', side=3, line=1, cex=1.5, font=2)#
axis(side=1, tick=FALSE, cex.axis=1.5,#
	at=cumsum(apply(venue_reason_table_f, 1, sum)) - 0.5*apply(venue_reason_table_f, 1, sum),#
	labels = c('sexual health', 'GP', 'elsewhere'),#
	)
quartz(width=11, height=7)#
layout(matrix(1:3, nrow=1, byrow=TRUE), widths=c(5,1,5), heights=7)#
par(oma=c(0,0,0,0), mar=c(5, 0, 5, 0))#
#par(omi = c(0,0,0,0))#, mai=c(1,0,1,0), las=1)#
#
mosaicplot(venue_reason_table_m, color=cols, xlab="", ylab="", main= "", las=1, cex.axis=0.001)#
mtext('Men', side=3, line=0.5, cex=1.5, font=2)#
axis(side=1, tick=FALSE, cex.axis=1.5,#
	at=cumsum(apply(venue_reason_table_m, 1, sum)) - 0.5*apply(venue_reason_table_m, 1, sum),#
	labels = c('sexual health', 'GP', 'elsewhere'),#
	)#
yl <- par("usr")[3:4]#
#
plot(0,0,pch="", xlim=c(-0.1,0.1), ylim=yl, xlab="", ylab="", bty="n", axes=FALSE)#
text(c(0,0,0), #
	1 - (cumsum(apply(venue_reason_table_f, 2, sum)) - 0.5*apply(venue_reason_table_f, 2, sum)), #
	c("other", "symptoms", "screen"),#
	cex=1.5)#
#
mosaicplot(venue_reason_table_f, color=cols, xlab="", ylab="", main= "", las=1, cex.axis=0.001)#
mtext('Women', side=3, line=0.5, cex=1.5, font=2)#
axis(side=1, tick=FALSE, cex.axis=1.5,#
	at=cumsum(apply(venue_reason_table_f, 1, sum)) - 0.5*apply(venue_reason_table_f, 1, sum),#
	labels = c('sexual health', 'GP', 'elsewhere'),#
	)
quartz(width=11, height=7)#
layout(matrix(1:3, nrow=1, byrow=TRUE), widths=c(5,1,5), heights=7)#
par(oma=c(0,0,0,0), mar=c(5, 0, 5, 0))#
#par(omi = c(0,0,0,0))#, mai=c(1,0,1,0), las=1)#
#
mosaicplot(venue_reason_table_m, color=cols, xlab="", ylab="", main= "", las=1, cex.axis=0.001)#
mtext('Men', side=3, line=0.5, cex=1.5, font=2)#
axis(side=1, tick=FALSE, cex.axis=1.5,#
	at=cumsum(apply(venue_reason_table_m, 1, sum)) - 0.5*apply(venue_reason_table_m, 1, sum),#
	labels = c('sexual health', 'GP', 'elsewhere'),#
	)#
yl <- par("usr")[3:4]#
#
plot(0,0,pch="", xlim=c(-0.1,0.1), ylim=yl, xlab="", ylab="", bty="n", axes=FALSE)#
text(c(0,0,0), #
	1 - (cumsum(apply(venue_reason_table_m, 2, sum)) - 0.5*apply(venue_reason_table_m, 2, sum)), #
	c("other", "symptoms", "screen"),#
	cex=1.5)#
#
mosaicplot(venue_reason_table_f, color=cols, xlab="", ylab="", main= "", las=1, cex.axis=0.001)#
mtext('Women', side=3, line=0.5, cex=1.5, font=2)#
axis(side=1, tick=FALSE, cex.axis=1.5,#
	at=cumsum(apply(venue_reason_table_f, 1, sum)) - 0.5*apply(venue_reason_table_f, 1, sum),#
	labels = c('sexual health', 'GP', 'elsewhere'),#
	)
venue_reason_table
venue_reason_table_m
quartz(width=11, height=7)#
layout(matrix(1:3, nrow=1, byrow=TRUE), widths=c(5,1,5), heights=7)#
par(oma=c(0,0,0,0), mar=c(5, 0, 5, 0))#
#par(omi = c(0,0,0,0))#, mai=c(1,0,1,0), las=1)#
#
mosaicplot(venue_reason_table_m, color=cols, xlab="", ylab="", main= "", las=1, cex.axis=0.001)#
mtext('Men', side=3, line=0.5, cex=1.5, font=2)#
axis(side=1, tick=FALSE, cex.axis=1.5,#
	at=cumsum(apply(venue_reason_table_m, 1, sum)) - 0.5*apply(venue_reason_table_m, 1, sum),#
	labels = c('sexual health', 'GP', 'elsewhere'),#
	)#
yl <- par("usr")[3:4]#
#
plot(0,0,pch="", xlim=c(-0.1,0.1), ylim=yl, xlab="", ylab="", bty="n", axes=FALSE)#
text(c(0,0,0), #
	1 - (cumsum(venue_reason_table_m['elsewhere',])) - 0.5*venue_reason_table_m['elsewhere',]), #
	c("other", "symptoms", "screen"),#
	cex=1.5)#
#
mosaicplot(venue_reason_table_f, color=cols, xlab="", ylab="", main= "", las=1, cex.axis=0.001)#
mtext('Women', side=3, line=0.5, cex=1.5, font=2)#
axis(side=1, tick=FALSE, cex.axis=1.5,#
	at=cumsum(apply(venue_reason_table_f, 1, sum)) - 0.5*apply(venue_reason_table_f, 1, sum),#
	labels = c('sexual health', 'GP', 'elsewhere'),#
	)
quartz(width=11, height=7)#
layout(matrix(1:3, nrow=1, byrow=TRUE), widths=c(5,1,5), heights=7)#
par(oma=c(0,0,0,0), mar=c(5, 0, 5, 0))#
#par(omi = c(0,0,0,0))#, mai=c(1,0,1,0), las=1)#
#
mosaicplot(venue_reason_table_m, color=cols, xlab="", ylab="", main= "", las=1, cex.axis=0.001)#
mtext('Men', side=3, line=0.5, cex=1.5, font=2)#
axis(side=1, tick=FALSE, cex.axis=1.5,#
	at=cumsum(apply(venue_reason_table_m, 1, sum)) - 0.5*apply(venue_reason_table_m, 1, sum),#
	labels = c('sexual health', 'GP', 'elsewhere'),#
	)#
yl <- par("usr")[3:4]#
#
plot(0,0,pch="", xlim=c(-0.1,0.1), ylim=yl, xlab="", ylab="", bty="n", axes=FALSE)#
text(c(0,0,0), #
	1 - (cumsum(venue_reason_table_m['elsewhere',])) - 0.5*venue_reason_table_m['elsewhere',])#
	c("other", "symptoms", "screen"),#
	cex=1.5)#
#
mosaicplot(venue_reason_table_f, color=cols, xlab="", ylab="", main= "", las=1, cex.axis=0.001)#
mtext('Women', side=3, line=0.5, cex=1.5, font=2)#
axis(side=1, tick=FALSE, cex.axis=1.5,#
	at=cumsum(apply(venue_reason_table_f, 1, sum)) - 0.5*apply(venue_reason_table_f, 1, sum),#
	labels = c('sexual health', 'GP', 'elsewhere'),#
	)
quartz(width=11, height=7)#
layout(matrix(1:3, nrow=1, byrow=TRUE), widths=c(5,1,5), heights=7)#
par(oma=c(0,0,0,0), mar=c(5, 0, 5, 0))#
#par(omi = c(0,0,0,0))#, mai=c(1,0,1,0), las=1)#
#
mosaicplot(venue_reason_table_m, color=cols, xlab="", ylab="", main= "", las=1, cex.axis=0.001)#
mtext('Men', side=3, line=0.5, cex=1.5, font=2)#
axis(side=1, tick=FALSE, cex.axis=1.5,#
	at=cumsum(apply(venue_reason_table_m, 1, sum)) - 0.5*apply(venue_reason_table_m, 1, sum),#
	labels = c('sexual health', 'GP', 'elsewhere'),#
	)#
yl <- par("usr")[3:4]
dev.off()
quartz(width=11, height=7)#
layout(matrix(1:3, nrow=1, byrow=TRUE), widths=c(5,1,5), heights=7)#
par(oma=c(0,0,0,0), mar=c(5, 0, 5, 0))#
#par(omi = c(0,0,0,0))#, mai=c(1,0,1,0), las=1)#
#
mosaicplot(venue_reason_table_m, color=cols, xlab="", ylab="", main= "", las=1, cex.axis=0.001)#
mtext('Men', side=3, line=0.5, cex=1.5, font=2)#
axis(side=1, tick=FALSE, cex.axis=1.5,#
	at=cumsum(apply(venue_reason_table_m, 1, sum)) - 0.5*apply(venue_reason_table_m, 1, sum),#
	labels = c('sexual health', 'GP', 'elsewhere'),#
	)#
yl <- par("usr")[3:4]#
#
plot(0,0,pch="", xlim=c(-0.1,0.1), ylim=yl, xlab="", ylab="", bty="n", axes=FALSE)#
text(c(0,0,0), #
	1 - (cumsum(venue_reason_table_m['elsewhere',])) - 0.5*venue_reason_table_m['elsewhere',])#
	c("other", "symptoms", "screen"),#
	cex=1.5)#
#
mosaicplot(venue_reason_table_f, color=cols, xlab="", ylab="", main= "", las=1, cex.axis=0.001)#
mtext('Women', side=3, line=0.5, cex=1.5, font=2)#
axis(side=1, tick=FALSE, cex.axis=1.5,#
	at=cumsum(apply(venue_reason_table_f, 1, sum)) - 0.5*apply(venue_reason_table_f, 1, sum),#
	labels = c('sexual health', 'GP', 'elsewhere'),#
	)
dev.off()
quartz(width=11, height=7)
par(oma=c(0,0,0,0), mar=c(5, 0, 5, 0))#
layout(matrix(1:3, nrow=1, byrow=TRUE), widths=c(5,1,5), heights=7)#
#par(omi = c(0,0,0,0))#, mai=c(1,0,1,0), las=1)#
#
mosaicplot(venue_reason_table_m, color=cols, xlab="", ylab="", main= "", las=1, cex.axis=0.001)#
mtext('Men', side=3, line=0.5, cex=1.5, font=2)#
axis(side=1, tick=FALSE, cex.axis=1.5,#
	at=cumsum(apply(venue_reason_table_m, 1, sum)) - 0.5*apply(venue_reason_table_m, 1, sum),#
	labels = c('sexual health', 'GP', 'elsewhere'),#
	)#
yl <- par("usr")[3:4]
cumsum(venue_reason_table_m['elsewhere',])
venue_reason_table_m['elsewhere',]
cumsum(venue_reason_table_m['elsewhere',])/sum(venue_reason_table_m['elsewhere',])
cumsum(venue_reason_table_m['elsewhere',]) - 0.5*venue_reason_table_m['elsewhere',]
cumsum(venue_reason_table_m['elsewhere',]) - 0.5*venue_reason_table_m['elsewhere',])/sum(venue_reason_table_m['elsewhere',])
(cumsum(venue_reason_table_m['elsewhere',]) - 0.5*venue_reason_table_m['elsewhere',])/sum(venue_reason_table_m['elsewhere',])
text(c(0,0,0), #
	1 - (cumsum(venue_reason_table_m['elsewhere',]) - 0.5*venue_reason_table_m['elsewhere',])/sum(venue_reason_table_m['elsewhere',])#
	c("other", "symptoms", "screen"),#
	cex=1.5)
plot(0,0,pch="", xlim=c(-0.1,0.1), ylim=yl, xlab="", ylab="", bty="n", axes=FALSE)
dev.off()#
quartz(width=11, height=7)#
par(oma=c(0,0,0,0), mar=c(5, 0, 5, 0))#
layout(matrix(1:3, nrow=1, byrow=TRUE), widths=c(5,1,5), heights=7)#
#par(omi = c(0,0,0,0))#, mai=c(1,0,1,0), las=1)#
#
mosaicplot(venue_reason_table_m, color=cols, xlab="", ylab="", main= "", las=1, cex.axis=0.001)#
mtext('Men', side=3, line=0.5, cex=1.5, font=2)#
axis(side=1, tick=FALSE, cex.axis=1.5,#
	at=cumsum(apply(venue_reason_table_m, 1, sum)) - 0.5*apply(venue_reason_table_m, 1, sum),#
	labels = c('sexual health', 'GP', 'elsewhere'),#
	)#
yl <- par("usr")[3:4]#
#
plot(0,0,pch="", xlim=c(-0.1,0.1), ylim=yl, xlab="", ylab="", bty="n", axes=FALSE)#
text(c(0,0,0), #
	1 - (cumsum(venue_reason_table_m['elsewhere',]) - 0.5*venue_reason_table_m['elsewhere',])/sum(venue_reason_table_m['elsewhere',]),#
	c("other", "symptoms", "screen"),#
	cex=1.5)
yl
text(c(0,0,0), #
	yl[2] - (yl[2]-yl[1])(cumsum(venue_reason_table_m['elsewhere',]) - 0.5*venue_reason_table_m['elsewhere',])/sum(venue_reason_table_m['elsewhere',]),#
	c("other", "symptoms", "screen"),#
	cex=1.5)
text(c(0,0,0), #
	yl[2] - (yl[2]-yl[1])*(cumsum(venue_reason_table_m['elsewhere',]) - 0.5*venue_reason_table_m['elsewhere',])/sum(venue_reason_table_m['elsewhere',]),#
	c("other", "symptoms", "screen"),#
	cex=1.5)
dev.off()#
quartz(width=11, height=7)#
par(oma=c(0,0,0,0), mar=c(5, 0, 5, 0))#
layout(matrix(1:3, nrow=1, byrow=TRUE), widths=c(5,1,5), heights=7)#
#par(omi = c(0,0,0,0))#, mai=c(1,0,1,0), las=1)#
#
mosaicplot(venue_reason_table_m, color=cols, xlab="", ylab="", main= "", las=1, cex.axis=0.001)#
mtext('Men', side=3, line=0.5, cex=1.5, font=2)#
axis(side=1, tick=FALSE, cex.axis=1.5,#
	at=cumsum(apply(venue_reason_table_m, 1, sum)) - 0.5*apply(venue_reason_table_m, 1, sum),#
	labels = c('sexual health', 'GP', 'elsewhere'),#
	)#
yl <- par("usr")[3:4]#
#
plot(0,0,pch="", xlim=c(-0.1,0.1), ylim=yl, xlab="", ylab="", bty="n", axes=FALSE)#
text(c(0,0,0), #
	yl[2] - (yl[2]-yl[1])*(cumsum(venue_reason_table_m['elsewhere',]) - 0.5*venue_reason_table_m['elsewhere',])/sum(venue_reason_table_m['elsewhere',]),#
	c("other", "symptoms", "screen"),#
	cex=1.5)
dev.off()#
quartz(width=11, height=7)#
par(oma=c(0,0,0,0), mar=c(5, 0, 5, 0))#
layout(matrix(1:3, nrow=1, byrow=TRUE), widths=c(5,1,5), heights=7)#
#par(omi = c(0,0,0,0))#, mai=c(1,0,1,0), las=1)#
#
mosaicplot(venue_reason_table_m, color=cols, xlab="", ylab="", main= "", las=1, cex.axis=0.001)#
mtext('Men', side=3, line=0.5, cex=1.5, font=2)#
axis(side=1, tick=FALSE, cex.axis=1.5,#
	at=cumsum(apply(venue_reason_table_m, 1, sum)) - 0.5*apply(venue_reason_table_m, 1, sum),#
	labels = c('sexual health', 'GP', 'elsewhere'),#
	)#
axis(side=4)#
yl <- par("usr")[3:4]#
#
plot(0,0,pch="", xlim=c(-0.1,0.1), ylim=yl, xlab="", ylab="", bty="n", axes=FALSE)#
text(c(0,0,0), #
	yl[2] - (yl[2]-yl[1])*(cumsum(venue_reason_table_m['elsewhere',]) - 0.5*venue_reason_table_m['elsewhere',])/sum(venue_reason_table_m['elsewhere',]),#
	c("other", "symptoms", "screen"),#
	cex=1.5)#
#
mosaicplot(venue_reason_table_f, color=cols, xlab="", ylab="", main= "", las=1, cex.axis=0.001)#
mtext('Women', side=3, line=0.5, cex=1.5, font=2)#
axis(side=1, tick=FALSE, cex.axis=1.5,#
	at=cumsum(apply(venue_reason_table_f, 1, sum)) - 0.5*apply(venue_reason_table_f, 1, sum),#
	labels = c('sexual health', 'GP', 'elsewhere'),#
	)
yl[2] - (yl[2]-yl[1])*(cumsum(venue_reason_table_m['elsewhere',]) - 0.5*venue_reason_table_m['elsewhere',])/sum(venue_reason_table_m['elsewhere',])
###################
# mosaic plots#
###################
#
cols <- c(rgb(135,93,167, maxColorValue = 256), rgb(168,91,74, maxColorValue = 256), rgb(143,183,113, maxColorValue = 256))#
#
venue_reason_table_m <- svytable(~ where3 + why4 , design=subset(tdesign, rsex == "Male"), Ntotal = 1 )#
venue_reason_table_f <- svytable(~ where3 + why4 , design=subset(tdesign, rsex == "Female"), Ntotal = 1  )#
#
dev.off()#
quartz(width=11, height=7)#
par(oma=c(0,0,0,0), mar=c(5, 0, 5, 0))#
layout(matrix(1:3, nrow=1, byrow=TRUE), widths=c(5,1,5), heights=7)#
#par(omi = c(0,0,0,0))#, mai=c(1,0,1,0), las=1)#
#
mosaicplot(venue_reason_table_m, color=cols, xlab="", ylab="", main= "", las=1, cex.axis=0.001)#
mtext('Men', side=3, line=0.5, cex=1.5, font=2)#
axis(side=1, tick=FALSE, cex.axis=1.5,#
	at=cumsum(apply(venue_reason_table_m, 1, sum)) - 0.5*apply(venue_reason_table_m, 1, sum),#
	labels = c('sexual health', 'GP', 'elsewhere'),#
	)#
axis(side=4)#
yl <- par("usr")[3:4]#
#
plot(0,0,pch="", xlim=c(-0.1,0.1), ylim=yl, xlab="", ylab="", bty="n", axes=FALSE)#
text(c(0,0,0), #
	yl[2] - (yl[2]-yl[1])*(cumsum(venue_reason_table_f['elsewhere',]) - 0.5*venue_reason_table_f['elsewhere',])/sum(venue_reason_table_f['elsewhere',]),#
	c("other", "symptoms", "screen"),#
	cex=1.5)#
#
mosaicplot(venue_reason_table_f, color=cols, xlab="", ylab="", main= "", las=1, cex.axis=0.001)#
mtext('Women', side=3, line=0.5, cex=1.5, font=2)#
axis(side=1, tick=FALSE, cex.axis=1.5,#
	at=cumsum(apply(venue_reason_table_f, 1, sum)) - 0.5*apply(venue_reason_table_f, 1, sum),#
	labels = c('sexual health', 'GP', 'elsewhere'),#
	)
dev.off()#
quartz(width=11, height=7)#
par(oma=c(0,0,0,0), mar=c(5, 0, 5, 0))#
layout(matrix(1:3, nrow=1, byrow=TRUE), widths=c(5,1,5), heights=7)#
#par(omi = c(0,0,0,0))#, mai=c(1,0,1,0), las=1)#
#
mosaicplot(venue_reason_table_m, color=cols, xlab="", ylab="", main= "", las=1, cex.axis=0.001)#
mtext('Men', side=3, line=0.5, cex=1.5, font=2)#
axis(side=1, tick=FALSE, cex.axis=1.5,#
	at=cumsum(apply(venue_reason_table_m, 1, sum)) - 0.5*apply(venue_reason_table_m, 1, sum),#
	labels = c('sexual health', 'GP', 'elsewhere'),#
	col=cols#
	)#
axis(side=4)#
yl <- par("usr")[3:4]#
#
plot(0,0,pch="", xlim=c(-0.1,0.1), ylim=yl, xlab="", ylab="", bty="n", axes=FALSE)#
text(c(0,0,0), #
	yl[2] - (yl[2]-yl[1])*(cumsum(venue_reason_table_f['elsewhere',]) - 0.5*venue_reason_table_f['elsewhere',])/sum(venue_reason_table_f['elsewhere',]),#
	c("other", "symptoms", "screen"),#
	cex=1.5)#
#
mosaicplot(venue_reason_table_f, color=cols, xlab="", ylab="", main= "", las=1, cex.axis=0.001)#
mtext('Women', side=3, line=0.5, cex=1.5, font=2)#
axis(side=1, tick=FALSE, cex.axis=1.5,#
	at=cumsum(apply(venue_reason_table_f, 1, sum)) - 0.5*apply(venue_reason_table_f, 1, sum),#
	labels = c('sexual health', 'GP', 'elsewhere'),#
	)
dev.off()#
quartz(width=11, height=7)#
par(oma=c(0,0,0,0), mar=c(5, 0, 5, 0))#
layout(matrix(1:3, nrow=1, byrow=TRUE), widths=c(5,1,5), heights=7)#
#par(omi = c(0,0,0,0))#, mai=c(1,0,1,0), las=1)#
#
mosaicplot(venue_reason_table_m, color=cols, xlab="", ylab="", main= "", las=1, cex.axis=0.001)#
mtext('Men', side=3, line=0.5, cex=1.5, font=2)#
axis(side=1, tick=FALSE, cex.axis=1.5,#
	at=cumsum(apply(venue_reason_table_m, 1, sum)) - 0.5*apply(venue_reason_table_m, 1, sum),#
	labels = c('sexual health', 'GP', 'elsewhere'),#
	col=cols#
	)#
yl <- par("usr")[3:4]#
#
plot(0,0,pch="", xlim=c(-0.1,0.1), ylim=yl, xlab="", ylab="", bty="n", axes=FALSE)#
text(c(0,0,0), #
	yl[2] - (yl[2]-yl[1])*(cumsum(venue_reason_table_f['elsewhere',]) - 0.5*venue_reason_table_f['elsewhere',])/sum(venue_reason_table_f['elsewhere',]),#
	c("other", "symptoms", "screen"),#
	cex=1.5)#
mtext('Reason for test', side=3, line=0.5, cex=1, font=2)#
#
mosaicplot(venue_reason_table_f, color=cols, xlab="", ylab="", main= "", las=1, cex.axis=0.001)#
mtext('Women', side=3, line=0.5, cex=1.5, font=2)#
axis(side=1, tick=FALSE, cex.axis=1.5,#
	at=cumsum(apply(venue_reason_table_f, 1, sum)) - 0.5*apply(venue_reason_table_f, 1, sum),#
	labels = c('sexual health', 'GP', 'elsewhere'),#
	)
# Analysis of Natsal data to investigate correlations between reason for test and test setting#
#
rm(list=ls())#
#
library(foreign)#
library(survey)#
library(vcd)#
#
options(survey.lonely.psu="adjust")#
#
natsal3 <- read.dta("/Users/Joanna/OneDrive - Imperial College London/backup/Natsal-3/UKDA-7799-stata11/stata11/eul_natsal_2010_for_archive.dta")#
#
#################################
# analysis on people who were tested for chlamydia#
#################################
#
# to be included in the subset tested for chlamydia in the last year, participants had to be:#
# sexually active (hetlife > 0 or samlife > 0)#
# aged < 45 (otherwise, were not asked whether they had tested)#
# EITHER diagnosed within the last year, OR reported testing within the last year#
#
tested <- natsal3[ (natsal3$whnchlam == "Less than 1 year ago") | (natsal3$chlmtest == "Yes"), ]#
tested <- tested[ tested$chlmtest != "No", ]#
tested <- tested[ !(tested$totlife %in% c(0,9999)), ]#
#
##### restrict to 16-24-year-olds#
tested <- tested[tested$agrp == "16-24",]#
#
##### reason recorded for chlamydia testing#
tested$why <- factor(NA, levels = levels(tested$chtstwy1))#
tested$why[!(tested$chtstwy1 %in% c("Not applicable", "Not answered"))] <- tested$chtstwy1[!(tested$chtstwy1 %in% c("Not applicable", "Not answered"))]#
tested$why[!(tested$chltstwy %in% c("Not applicable", "Not answered"))] <- tested$chltstwy[!(tested$chltstwy %in% c("Not applicable", "Not answered"))]#
tested$why <- droplevels(tested$why)#
#
##### amalgamate two categories into "partner", and three into "screen"#
tested$why2 <- NA#
tested$why2[tested$why == "I had symptoms"] <- "symptoms"#
tested$why2[tested$why %in% c("My partner had symptoms", "I was notified because a partner was diagnosed with Chlamydia")] <- "partner"#
tested$why2[tested$why == "Check up after previous positive test"] <- "re-test"#
tested$why2[tested$why %in% c("I wanted a general sexual health check-up", "I had no symptoms but I was worried about the risk of Chlamydia", "I was offered a routine test")] <- "screen"#
tested$why2[tested$why == "Other"] <- "other"#
tested$why2 <- factor(tested$why2, levels = names(table(tested$why2))[order(table(tested$why2), decreasing=TRUE)], ordered = TRUE)#
#
##### distinguish between patient-initiated and provider-initiated screens#
tested$why3 <- as.character(tested$why2)#
tested$why3[tested$why %in% c("I wanted a general sexual health check-up", "I had no symptoms but I was worried about the risk of Chlamydia")] <- "screen - patient init"#
tested$why3[tested$why == "I was offered a routine test"] <- "screen - provider init"#
tested$why3 <- factor(tested$why3, levels = names(table(tested$why3))[order(table(tested$why3), decreasing=TRUE)], ordered = TRUE)#
#
##### symptoms/screen/other#
tested$why4 <- as.character(tested$why2)#
tested$why4[tested$why2 %in% c("partner", "re-test", "other")] <- "other"#
tested$why4 <- factor(tested$why4, levels = c("other", "symptoms", "screen"), ordered = TRUE)#
#
##### symptoms/screen/other#
tested$why5 <- as.character(tested$why2)#
tested$why5[tested$why2 %in% c("partner", "re-test", "other")] <- "screen"#
tested$why5 <- factor(tested$why5, levels = c("symptoms", "screen"), ordered = TRUE)#
##### where were tests carried out?#
tested$where <- factor(NA, levels = unique(c(levels(tested$chtstwh1), levels(tested$chltstwh))))#
tested$where[!(tested$chtstwh1 %in% c("Not applicable", "Not answered"))] <- tested$chtstwh1[!(tested$chtstwh1 %in% c("Not applicable", "Not answered"))]#
tested$where[!(tested$chltstwh %in% c("Not applicable", "Not answered"))] <- tested$chltstwh[!(tested$chltstwh %in% c("Not applicable", "Not answered"))]#
tested$where[tested$where == "NHS Family planning clinic / contraceptive clinic / reproductive health clinic"] <- "NHS FP clinic / contraceptive clinic / reproductive health clinic"#
tested$where <- droplevels(tested$where)#
#
##### combine categories#
tested$where2 <- NA#
tested$where2[tested$where == "Sexual health clinic (GUM clinic)"] <- "sexual health"#
tested$where2[tested$where == "General practice (GP) surgery"] <- "GP"#
tested$where2[tested$where == "NHS FP clinic / contraceptive clinic / reproductive health clinic"] <- "family planning"#
tested$where2[tested$where == "School / college / university"] <- "education"#
tested$where2[tested$where %in% c("Ante-natal Clinic / midwife", "Private non-NHS clinics or doctor", "Youth advisory clinic (e.g. Brook Clinic)", "Termination of pregnancy (abortion) clinic", "Hospital accident and emergency (A&E) department", "Pharmacy / chemist", "Internet", "Other non-health care place, e.g. youth club, festival, bar", "Somewhere else")] <- "elsewhere"#
#
tested$where2 <- factor(tested$where2, levels = names(table(tested$where2))[order(table(tested$where2), decreasing=TRUE)], ordered = TRUE)#
#
##### only three categories#
tested$where3 <- tested$where2#
tested$where3[tested$where2 %in% c("family planning", "education", "elsewhere")] <- "elsewhere"#
tested$where3 <- factor(tested$where3, levels = c("sexual health", "GP", "elsewhere"), ordered = TRUE)#
##### group deprivation quintiles#
tested$imd_grouped <- factor(tested$adj_imd_quintile, levels=1:5, labels=c("1-2","1-2","3","4-5","4-5"))#
#
tested$nncg <- tested$nonocong#
tested$nncg[!(tested$nncg %in% c("No unprotected vaginal/anal het. sex in last year", "1 partner", "2+ partners"))] <- NA#
tested$nncg <- droplevels(tested$nncg)#
#
tested$tny3 <- tested$totnewy3#
tested$tny3[!(tested$tny3 %in% c("0 new het.&/or sam. partners in last year", "1 new het.&/or sam. partner in last year", "2+ new het.&/or sam. partners in last year"))] <- NA#
tested$tny3 <- droplevels(tested$tny3)#
#
# set up survey design#
tdesign <- svydesign( #
		id = ~psu_scrm , #
		strata = ~stratagrp3 ,#
		data = tested ,		#
		weight = ~total_wt #
	)#
#
###################
# mosaic plots#
###################
#
cols <- c(rgb(135,93,167, maxColorValue = 256), rgb(168,91,74, maxColorValue = 256), rgb(143,183,113, maxColorValue = 256))#
#
venue_reason_table_m <- svytable(~ where3 + why4 , design=subset(tdesign, rsex == "Male"), Ntotal = 1 )#
venue_reason_table_f <- svytable(~ where3 + why4 , design=subset(tdesign, rsex == "Female"), Ntotal = 1  )#
#
dev.off()#
quartz(width=11, height=7)#
par(oma=c(0,0,0,0), mar=c(5, 0, 5, 0))#
layout(matrix(1:3, nrow=1, byrow=TRUE), widths=c(5,1,5), heights=7)#
#par(omi = c(0,0,0,0))#, mai=c(1,0,1,0), las=1)#
#
mosaicplot(venue_reason_table_m, color=cols, xlab="", ylab="", main= "", las=1, cex.axis=0.001)#
mtext('Men', side=3, line=0.5, cex=1.5, font=2)#
axis(side=1, tick=FALSE, cex.axis=1.5,#
	at=cumsum(apply(venue_reason_table_m, 1, sum)) - 0.5*apply(venue_reason_table_m, 1, sum),#
	labels = c('sexual health', 'GP', 'elsewhere'),#
	col=cols#
	)#
yl <- par("usr")[3:4]#
#
plot(0,0,pch="", xlim=c(-0.1,0.1), ylim=yl, xlab="", ylab="", bty="n", axes=FALSE)#
text(c(0,0,0), #
	yl[2] - (yl[2]-yl[1])*(cumsum(venue_reason_table_f['elsewhere',]) - 0.5*venue_reason_table_f['elsewhere',])/sum(venue_reason_table_f['elsewhere',]),#
	c("other", "symptoms", "screen"),#
	cex=1.5)#
mtext('Reason for test', side=3, line=0.5, cex=1, font=2)#
#
mosaicplot(venue_reason_table_f, color=cols, xlab="", ylab="", main= "", las=1, cex.axis=0.001)#
mtext('Women', side=3, line=0.5, cex=1.5, font=2)#
axis(side=1, tick=FALSE, cex.axis=1.5,#
	at=cumsum(apply(venue_reason_table_f, 1, sum)) - 0.5*apply(venue_reason_table_f, 1, sum),#
	labels = c('sexual health', 'GP', 'elsewhere'),#
	)
source("/Users/Joanna/OneDrive - Imperial College London/backup/ct_trends_master/Natsal_symptoms_testing/natsal3_ct_testing/run-3-comp-model-stratified-men.R")
setwd('~/OneDrive - Imperial College London/backup/ct_trends_master/Natsal_symptoms_testing/natsal3_ct_testing')
natsal3 <- read.dta("/Users/Joanna/OneDrive - Imperial College London/backup/Natsal-3/UKDA-7799-stata11/stata11/eul_natsal_2010_for_archive.dta")#
#
natsal3$tested <- NA#
natsal3$tested[ (natsal3$whnchlam == "Less than 1 year ago") | (natsal3$chlmtest == "Yes") ] <- TRUE#
natsal3$tested[ natsal3$chlmtest == "No" ] <- FALSE#
natsal3$tested[natsal3$totlife %in% c(0,9999)] <- NA#
#
natsal3$why <- factor(NA, levels = levels(natsal3$chtstwy1))#
natsal3$why[!(natsal3$chtstwy1 %in% c("Not applicable", "Not answered"))] <- natsal3$chtstwy1[!(natsal3$chtstwy1 %in% c("Not applicable", "Not answered"))]#
natsal3$why[!(natsal3$chltstwy %in% c("Not applicable", "Not answered"))] <- natsal3$chltstwy[!(natsal3$chltstwy %in% c("Not applicable", "Not answered"))]#
natsal3$why <- droplevels(natsal3$why)#
#
natsal3$why2 <- NA#
natsal3$why2[natsal3$why == "I had symptoms"] <- "symptoms"#
natsal3$why2[natsal3$why %in% c("My partner had symptoms", "I was notified because a partner was diagnosed with Chlamydia")] <- "partner"#
natsal3$why2[natsal3$why == "Check up after previous positive test"] <- "re-test"#
natsal3$why2[natsal3$why %in% c("I wanted a general sexual health check-up", "I had no symptoms but I was worried about the risk of Chlamydia", "I was offered a routine test")] <- "screen"#
natsal3$why2[natsal3$why == "Other"] <- "other"#
natsal3$why2 <- factor(natsal3$why2, levels = names(table(natsal3$why2))[order(table(natsal3$why2), decreasing=TRUE)], ordered = TRUE)#
#
sub <- subset(natsal3, natsal3$totnewy3 %in% c("0 new het.&/or sam. partners in last year","1 new het.&/or sam. partner in last year", "2+ new het.&/or sam. partners in last year"))#
sub$totnewy3 <- factor(as.character(sub$totnewy3))#
#
init0 <- list(p_symp = 0.5, lambda_slow = 0.74, foi = rep(0.001, times=3), scr = rep(0.001, times=3), trt = 0.001)#
#
dt0 <- list(#
  N = nrow(sub[sub$agrp == "16-24" & sub$rsex == "Male" & !is.na(sub$tested),]),#
  N_strata = length(unique(sub$totnewy3)),#
  str = (as.numeric(sub$totnewy3[sub$agrp == "16-24" & sub$rsex == "Male" & !is.na(sub$tested)])),#
  wt = sub$total_wt[sub$agrp == "16-24" & sub$rsex == "Male" & !is.na(sub$tested)],#
  tested = sub$tested[sub$agrp == "16-24" & sub$rsex == "Male" & !is.na(sub$tested)],#
  symp = sub$why2[sub$agrp == "16-24" & sub$rsex == "Male" & !is.na(sub$tested)] == "symptoms",#
#  symp = sub$why2[sub$agrp == "16-24" & sub$rsex == "Male" & !is.na(sub$tested)] %in% c("symptoms","partner","re-test","other"),#
  diag = sub$whnchlam[sub$agrp == "16-24" & sub$rsex == "Male" & !is.na(sub$tested)] == "Less than 1 year ago"#
)#
#
dt0$symp[is.na(dt0$symp)] <- -99#
#
fit0 <-stan(#
  file = '3-comp-model-stratified-men.stan',#
  data = dt0,#
  chains = 1,#
  iter = 10000,#
  warmup = 1000,#
  init = list(init0),#
  seed = 12345#
)#
#
op0 <- extract(fit0)
# plot to show positivity#
#
par(mfrow=c(1,1), mar=c(5.1, 4.1, 4.1, 4.1))#
#
mli <- which(op0$lp__ == max(op0$lp__))[1]#
#
trt <- op0$trt[mli] # treatment seeking rate in symptomatic people#
sc <- op0$lambda_slow[mli] # rate of natural recovery (self-clear)#
p_symp <- op0$p_symp[mli] # proportion of incident infections that develop symptoms#
#
foi <- matrix(rep(seq(0,0.4,0.0005), times = 751), nrow=751, byrow=TRUE) # 801 values#
scr <- matrix(rep(seq(0,1.5,0.002), each = 801), nrow=751, byrow=TRUE) # 751 values#
#
alpha_AU <- scr + sc#
alpha_UA <- foi * (1 - p_symp)#
alpha_SU <- scr + sc + trt#
alpha_US <- foi * p_symp#
#
S <- alpha_AU*alpha_US/(alpha_AU*alpha_US + alpha_SU*(alpha_AU + alpha_UA))#
A <- alpha_SU*alpha_UA/(alpha_AU*alpha_US + alpha_SU*(alpha_AU + alpha_UA))#
#
tr <- scr + trt*S#
dr <- scr*(S + A) + trt*S#
#
positivity <- dr/tr#
#
image(foi[1,], scr[,1], t(positivity), #
      col=gray(seq(1,0,-0.001)), #
      useRaster=TRUE, #
      xlab=expression("Force of infection (" ~ year^{-1} ~ ")"), #
      ylab=expression("Screening rate (" ~ year^{-1} ~ ")"), #
      main = "Test positivity in men",#
      xlim = c(0, 0.2), ylim=c(0, 0.8), zlim=c(0,1)#
      )#
#
cs <- contourLines(foi[1,], scr[,1], t(positivity), #
                   levels=c(0.01, 0.02, 0.05, 0.1, 0.15, 0.2, 0.5))#
contour(foi[1,], scr[,1], t(positivity), #
        add=TRUE, #
        levels=c(0.01, 0.02, 0.05, 0.1, 0.15, 0.2, 0.5), #
        lwd=1,#
        drawlabels=FALSE)#
#
for(i in 1:5)#
  text(cs[[i]][["x"]][which(cs[[i]][["y"]] < 0.8)[1]], #
       cs[[i]][["y"]][which(cs[[i]][["y"]] < 0.8)[1]], #
       paste(100*cs[[i]][['level']], '%', sep=""), #
       adj=c(0,2)#
       )#
for(i in 6:7)#
  text(cs[[i]][["x"]][which(cs[[i]][["x"]] < 0.2)[1]], #
       cs[[i]][["y"]][which(cs[[i]][["x"]] < 0.2)[1]], #
       paste(100*cs[[i]][['level']], '%', sep=""), #
       adj=c(-2,0), pos=2#
       )#
z1 <- ks::kde(matrix(c(op0$foi[,1], op0$scr[,1]), ncol=2))#
z2 <- ks::kde(matrix(c(op0$foi[,2], op0$scr[,2]), ncol=2))#
z3 <- ks::kde(matrix(c(op0$foi[,3], op0$scr[,3]), ncol=2))#
#
contour(z1$eval.points[[1]], z1$eval.points[[2]], z1$estimate, #
        levels = z1$cont['5%'], #
        add=TRUE, drawlabels=FALSE, lty=1, lwd=3, col='darkgreen')#
#text(0.05, 0.3, '0 new \npartners', adj=c(0,1))#
contour(z2$eval.points[[1]], z2$eval.points[[2]], z2$estimate, #
        levels = z2$cont['5%'], #
        add=TRUE, drawlabels=FALSE, lty=1, lwd=3, col='blue')#
#text(0.07, 0.45, '1 new \npartner', adj=c(0,1))#
contour(z3$eval.points[[1]], z3$eval.points[[2]], z3$estimate, #
        levels = z3$cont['5%'], #
        add=TRUE, drawlabels=FALSE, lty=1, lwd=3, col='red')#
#text(0.13, 0.65, '2+ new \npartners', adj=c(0,1))#
#
legend('bottomright', inset = c(0.05,0.15),#
       col = c('darkgreen', 'blue', 'red'),#
       lwd = 3,#
       legend = c('0 new partners', '1 new partner', '≥2 new partners'),#
       bty = 'n')#
#
mtext('A', side=3, line=0.5, at=0.215, cex=5)
